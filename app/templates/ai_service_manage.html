<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI服务与模板管理 - 小说编辑器</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .management-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fdfdfd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .management-section h2, .management-section h3, .management_section h4 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .ai-config-form div, #prompt-template-form div {
            margin-bottom: 15px;
        }
        .ai-config-form label, #prompt-template-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .ai-config-form input[type="text"],
        .ai-config-form input[type="password"],
        .ai-config-form select,
        #prompt-template-form input[type="text"],
        #prompt-template-form textarea {
            width: calc(100% - 20px); /* Adjust width considering padding */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
        }
        .ai-config-form select {
             width: 100%; /* Select width needs to be 100% */
        }
        .ai-config-form small, #prompt-template-form small {
             display: block;
             margin-top: 5px;
             color: #666;
             font-size: 0.9em;
        }
        button, .button-link {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em;
            margin-right: 5px;
            text-decoration: none; /* For button-link */
            display: inline-block; /* For button-link */
            vertical-align: middle;
        }
        button[type="submit"] {
            background-color: #007bff;
            color: white;
        }
        button[type="submit"]:hover {
            background-color: #0056b3;
        }
        .delete-link, .make-system-link, .edit-btn, .delete-btn {
            padding: 5px 10px;
            font-size: 0.9em;
            margin-right: 5px;
            text-decoration: none;
            display: inline-block;
            border-radius: 3px;
        }
        .delete-link, .delete-btn {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .delete-link:hover, .delete-btn:hover {
            background-color: #f1b0b7;
        }
        .make-system-link {
             background-color: #d1ecf1;
             color: #0c5460;
             border: 1px solid #bee5eb;
        }
        .make-system-link:hover {
             background-color: #abdde5;
        }
        .edit-btn {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .edit-btn:hover {
             background-color: #b1dfbb;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .flashes {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }
        .flashes li {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid transparent;
            border-radius: 4px;
            background-color: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
        .template-preview {
            max-height: 100px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word; /* changed from break-all */
            font-size: 0.9em;
            color: #333;
        }
         /* Add styles for the new editor section */
         #prompt-template-editor {
             /* Inherits .management-section styles if wrapped */
             /* margin-bottom: 20px; */ /* Already handled by management-section */
             /* padding: 15px; */
             /* border: 1px solid #ccc; */
             /* border-radius: 5px; */
             /* background-color: #f9f9f9; */
         }
         #prompt-template-editor h3 {
             margin-top: 0;
             /* border-bottom, padding, margin handled by management-section h3 */
         }
         .form-message {
             margin-top: 10px;
             padding: 10px;
             border-radius: 4px;
             font-weight: bold;
         }
         .form-message-success {
             color: #155724;
             background-color: #d4edda;
             border: 1px solid #c3e6cb;
         }
         .form-message-error {
             color: #721c24;
             background-color: #f8d7da;
             border: 1px solid #f5c6cb;
         }

        /* Right Collapsible Panel Styles - Copied from user_manage.html */
        #ai-service-right-panel {
            height: calc(100vh - 60px); /* Full height below top-bar */
            position: fixed; 
            right: 0;
            top: 60px; 
            background-color: #f8f9fa; 
            border-left: 1px solid #e0e0e0;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1); /* Shadow on the left side */
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out; 
            overflow: hidden; 
            z-index: 999; 
            transform: translateX(calc(100% - 45px)); /* Initially collapsed, showing only handle width */
            width: 320px; /* Default fixed width when collapsed or partially shown */
        }

        #ai-service-right-panel.expanded {
            transform: translateX(0); /* Slides in to be fully visible */
            width: 30%; /* Expanded width, adjust as needed */
        }

        .ai-panel-toggle-handle {
            width: 45px; 
            height: 100%;
            position: absolute;
            left: 0; 
            top: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background-color: #e9eef2;
            border-right: 1px solid #d0d7de; 
            box-sizing: border-box;
        }
        
        #ai-service-right-panel.expanded .ai-panel-toggle-handle {
             background-color: #dde3e8;
        }

        .ai-panel-toggle-handle .ai-panel-handle-text {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            margin-top: 15px;
            font-size: 14px;
            font-weight: bold;
            color: #444;
            white-space: nowrap;
        }

        .ai-panel-toggle-handle #ai-panel-toggle-icon {
            font-size: 16px;
            color: #333;
            transition: transform 0.3s ease-in-out;
        }

        #ai-service-right-panel.expanded #ai-panel-toggle-icon {
            transform: rotate(180deg); 
        }

        .ai-panel-actual-content {
            padding: 20px;
            margin-left: 45px; /* Offset by handle width */
            width: calc(100% - 45px); 
            box-sizing: border-box;
            height: 100%;
            overflow-y: auto;
        }

        .ai-panel-actual-content h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }

        /* Custom styles for the new AI preferences UI */
        .preference-group {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .preference-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .preference-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
        }
        .preference-group input[type="number"],
        .preference-group textarea {
            width: calc(100% - 16px); /* Full width minus padding */
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.95em;
            margin-bottom: 5px;
            box-sizing: border-box;
        }
        .preference-group .color-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .preference-group .color-inputs input[type="number"] {
            width: 60px; /* Smaller width for RGB inputs */
            text-align: center;
        }
        .preference-group .color-inputs span {
            font-weight: bold;
        }
        #ai-style-preview {
            width: 100%;
            min-height: 50px;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background-color: #f0f0f0; /* Default background */
            color: #333; /* Default text color */
            transition: background-color 0.3s, color 0.3s;
            font-size: 1.1em;
        }
        .preference-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .preference-group input[type="checkbox"] {
            margin-right: 8px;
            vertical-align: middle;
        }
        .preference-group .checkbox-label {
            font-weight: normal;
            display: inline;
            vertical-align: middle;
        }
        .preference-actions {
            display: flex;
            gap: 10px; /* Space between buttons */
            margin-top: 20px;
        }
        .save-preferences-btn {
            background-color: #007bff; /* 深蓝色 */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            flex-grow: 1; /* Allow buttons to share space */
            text-align: center;
        }
        .save-preferences-btn:hover {
            background-color: #0056b3; /* 深蓝色悬停 */
        }
        .default-settings-btn {
            background-color: #cfe2ff; /* 浅蓝色 */
            color: #084298; /* 深色文字以保证对比度 */
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            flex-grow: 1; /* Allow buttons to share space */
        }
        .default-settings-btn:hover {
            background-color: #e0a800;
        }
        #ai-prefs-status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
            display: none; /* Hidden by default */
        }
        #ai-prefs-status-message.success {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }
        #ai-prefs-status-message.error {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }

    </style>
    <!-- 引入 Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="top-bar">
        <div class="right-buttons">
            <a href="{{ url_for('main.index') }}" class="top-btn">返回主页</a>
            <a href="{{ url_for('main.logout') }}" class="top-btn">退出登录</a>
        </div>
    </div>
    <div class="main-content" data-is-admin="{{ is_admin|string|lower }}"> <!-- Pass is_admin to JS -->
        <h1>AI服务与模板管理</h1>

        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <ul class="flashes">
            {% for message in messages %}
              <li>{{ message }}</li>
            {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        <!-- AI 服务管理部分 -->
        <div class="management-section" id="ai-service-management">
             <h2>AI 服务配置</h2>
             
             <!-- 添加/编辑自定义配置 -->
             <div class="management-section" id="add-edit-ai-config">
                 <h3 id="ai-config-form-title">添加自定义配置</h3>
                 <form method="post" class="ai-config-form" id="ai-config-form">
                     <input type="hidden" id="ai-config-id" name="config_id"> <!-- Hidden field for editing -->
                     <div>
                         <label for="ai-name">配置名称:</label>
                         <input type="text" id="ai-name" name="name" placeholder="给配置起个名字 (例如 My OpenAI)" required>
                     </div>
                     <div>
                         <label for="ai-service-type">服务类型:</label>
                         <select id="ai-service-type" name="service_type" required>
                             <option value="" disabled selected>--请选择服务类型--</option>
                             <option value="openai">OpenAI</option>
                             <option value="deepseek">DeepSeek</option>
                             <option value="groq">Groq</option>
                             <option value="ollama">Ollama (本地)</option>
                             <option value="custom_openai_compatible">其他 OpenAI 兼容 API</option>
                             <!-- 在这里可以添加更多类型 -->
                         </select>
                     </div>
                     <div>
                         <label for="ai-base-url">基础 URL:</label>
                         <input type="text" id="ai-base-url" name="base_url" placeholder="访问服务器的 URL (例如 https://api.openai.com)" required>
                         <small>对于 OpenAI 兼容 API，通常是包含 `/v1` 的上一级目录，例如 `https://api.openai.com` 或 `http://localhost:11434` (对于 Ollama)</small>
                     </div>
                     <div>
                         <label for="ai-model-name">模型名称:</label>
                         <input type="text" id="ai-model-name" name="model_name" placeholder="模型标识符 (例如 gpt-4, deepseek-coder)" required>
                     </div>
                     <div>
                         <label for="ai-api-key">API Key:</label>
                         <input type="password" id="ai-api-key" name="api_key" placeholder="输入新 API Key (编辑时留空表示不更改)">
                         <small>API Key 将被安全存储，不会在界面显示。</small>
                     </div>
                     <div>
                         <button type="submit" id="ai-config-submit-btn">添加自定义配置</button>
                         <button type="button" id="ai-config-cancel-btn" style="display: none;">取消编辑</button>
                     </div>
                     <div id="ai-config-form-message" class="form-message"></div>
                 </form>
             </div>
             
             <!-- 显示已配置服务 -->
             <div class="management-section" id="existing-ai-configs">
                 <h3>已配置的 AI 服务</h3>
                 
                 <h4>系统预设服务</h4>
                 <table id="system-ai-configs-table">
                      <thead><tr><th>ID</th><th>名称</th><th>类型</th><th>模型</th><th>基础 URL</th><th>所有者</th><th>启用</th><th>操作</th></tr></thead>
                      <tbody id="system-ai-configs-tbody">
                         {% if system_configs %}
                             {% for config in system_configs %}
                             <tr data-config-id="{{ config.id }}">
                                 <td>{{ config.id }}</td>
                                 <td>{{ config.name }}</td>
                                 <td>{{ config.service_type }}</td>
                                 <td>{{ config.model_name }}</td>
                                 <td>{{ config.base_url }}</td>
                                 <td>{% if config.owner %}{{ config.owner.username }}{% else %}系统{% endif %}</td>
                                 <td>
                                     <input type="radio" name="active_ai_config" value="{{ config.id }}" 
                                            id="config-{{ config.id }}" 
                                            {% if config.id == active_config_id %}checked{% endif %}>
                                 </td>
                                 <td>
                                     {% if is_admin %}
                                     <a href="#" class="edit-btn ai-edit-btn" data-id="{{ config.id }}">编辑</a>
                                     <a href="#" class="delete-link system-delete-btn" data-id="{{ config.id }}" data-name="{{ config.name|escape }}">删除</a>
                                     {% else %}
                                     -
                                     {% endif %}
                                 </td>
                             </tr>
                             {% endfor %}
                         {% else %}
                             <tr><td colspan="8">无系统预设服务。</td></tr>
                         {% endif %}
                      </tbody>
                 </table>
                 
                 <h4>我的自定义服务</h4>
                 <table id="user-ai-configs-table">
                      <thead><tr><th>ID</th><th>名称</th><th>类型</th><th>模型名称</th><th>基础 URL</th><th>启用</th><th>操作</th></tr></thead>
                      <tbody id="user-ai-configs-tbody">
                     {% if user_configs %}
                         {% for config in user_configs %}
                         <tr data-config-id="{{ config.id }}">
                             <td>{{ config.id }}</td>
                             <td>{{ config.name }}</td>
                             <td>{{ config.service_type }}</td>
                             <td>{{ config.model_name }}</td>
                             <td>{{ config.base_url }}</td>
                             <td>
                                 <input type="radio" name="active_ai_config" value="{{ config.id }}" 
                                        id="config-{{ config.id }}" 
                                        {% if config.id == active_config_id %}checked{% endif %}>
                             </td>
                             <td>
                                 <a href="#" class="edit-btn ai-edit-btn" data-id="{{ config.id }}">编辑</a>
                                 <a href="{{ url_for('ai_service.delete', config_id=config.id) }}" onclick="return confirm('确定删除配置 \'{{ config.name|escape }}\'？')" class="delete-link user-delete-btn">删除</a>
                                 {% if is_admin %}
                                 <a href="#" class="make-system-link" data-id="{{ config.id }}" data-name="{{ config.name|escape }}">设为系统预设</a>
                                 {% endif %}
                             </td>
                         </tr>
                         {% endfor %}
                     {% else %}
                          <tr><td colspan="7">您还没有添加自定义 AI 服务配置。</td></tr>
                     {% endif %}
                      </tbody>
                 </table>
             </div>
        </div>

        <hr> 

        <!-- 提示词模板管理部分 -->
        <div class="management-section" id="prompt-template-management">
            <h2>提示词模板管理</h2>
            <div id="prompt-template-editor" > <!-- Removed data-is-admin here, get from parent -->
                <h3>添加/编辑模板 {% if not is_admin %}(仅管理员可操作){% endif %}</h3>
                <form id="prompt-template-form" {% if not is_admin %}style="display: none;"{% endif %}>
                    <input type="hidden" id="template-id">
                    <div>
                        <label for="template-name">模板名称:</label>
                        <input type="text" id="template-name" name="name" required>
                    </div>
                    <div>
                        <label for="template-string">模板内容:</label>
                        <textarea id="template-string" name="template_string" rows="6" required placeholder="使用 @[占位符] 编辑模板，例如：参考@[提示词]，以@[风格]的风格..."></textarea>
                        <small>支持的占位符: @[前文], @[后文], @[提示词], @[字数], @[风格], @[设定]</small>
                    </div>
                    <div>
                        <label for="template-is-default">设为系统默认:</label>
                        <input type="checkbox" id="template-is-default" name="is_default"> 
                         <small>(仅管理员可修改系统模板的默认状态)</small>
                    </div>
                    <div>
                        <button type="submit">保存模板</button>
                        <button type="button" id="clear-template-form">清空/取消编辑</button>
                    </div>
                </form>
                 <div id="template-form-message" class="form-message"></div>
            </div>

            <h3>现有模板 (系统 + 我的)</h3>
            <table id="prompt-templates-table">
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>模板内容 (预览)</th>
                        <th>系统默认?</th>
                        <th>类型</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="prompt-templates-tbody">
                    <!-- JS will populate this -->
                </tbody>
            </table>
        </div>

    </div>

    {# New Right Collapsible Panel for AI Service Management #}
    <div id="ai-service-right-panel" class="collapsed"> 
        <div class="ai-panel-toggle-handle" title="扩展功能面板">
            <i id="ai-panel-toggle-icon" class="fas fa-chevron-left"></i>
            <span class="ai-panel-handle-text">功能区</span>
        </div>
        <div class="ai-panel-actual-content">
            <h3>AI 用户偏好设置</h3>
            <hr>

            <div id="user-ai-preferences-form">
                <!-- 1. AI 生成内容样式设置 -->
                <div class="preference-group">
                    <label>AI 生成内容样式预览:</label>
                    <div id="ai-style-preview">这是 AI 生成内容的预览文本。</div>
                    
                    <label for="ai-bg-color-r">背景颜色 (RGB):</label>
                    <div class="color-inputs">
                        <span>R:</span> <input type="number" id="ai-bg-color-r" min="0" max="255" value="255">
                        <span>G:</span> <input type="number" id="ai-bg-color-g" min="0" max="255" value="240">
                        <span>B:</span> <input type="number" id="ai-bg-color-b" min="0" max="255" value="240">
                    </div>

                    <label for="ai-font-color-r">字体颜色 (RGB):</label>
                    <div class="color-inputs">
                        <span>R:</span> <input type="number" id="ai-font-color-r" min="0" max="255" value="51">
                        <span>G:</span> <input type="number" id="ai-font-color-g" min="0" max="255" value="51">
                        <span>B:</span> <input type="number" id="ai-font-color-b" min="0" max="255" value="51">
                    </div>
                </div>

                <!-- 2. 重试提示词模板 -->
                <div class="preference-group">
                    <label for="retry-prompt-template">重试提示词追加模板:</label>
                    <textarea id="retry-prompt-template" placeholder="例如：请根据以上反馈，调整你的回答。"></textarea>
                    <small>此模板内容将在点击"重试"时，追加到原始提示词的末尾。使用 `@[原回复]` 来引用 AI 上一次生成的内容。</small>
                </div>

                <!-- 3. Markdown 提示词模板 -->
                <div class="preference-group">
                    <div>
                        <input type="checkbox" id="enable-markdown-prompt">
                        <label for="enable-markdown-prompt" class="checkbox-label">启用 Markdown 输出模式</label>
                    </div>
                    <label for="markdown-prompt-template" style="margin-top:10px;">Markdown 模式提示词追加模板:</label>
                    <textarea id="markdown-prompt-template" placeholder="例如：请使用 Markdown 格式化你的回答，包括标题、列表、粗体等。"></textarea>
                    <small>若启用，此模板内容将追加到提示词末尾，以引导 AI 返回 Markdown 格式内容。</small>
                </div>

                <div class="preference-actions">
                    <button id="save-user-ai-prefs-btn" class="save-preferences-btn">保存用户偏好设置</button>
                    <button id="use-default-ai-prefs-btn" class="default-settings-btn">使用默认设置</button>
                </div>
                <div id="admin-only-actions" style="margin-top: 15px; display: none;">
                    <button id="export-system-defaults-btn" class="default-settings-btn" style="background-color: #6c757d; color: white;">将当前配置导出为系统默认</button>
                </div>
                <div id="ai-prefs-status-message"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mainContentDiv = document.querySelector('.main-content');
            const isAdmin = mainContentDiv.dataset.isAdmin === 'true'; // Get admin status ONCE here

            // --- AI Service Configuration Form Handling ---
            const aiConfigForm = document.getElementById('ai-config-form');
            const aiConfigIdInput = document.getElementById('ai-config-id');
            const aiNameInput = document.getElementById('ai-name');
            const aiServiceTypeSelect = document.getElementById('ai-service-type');
            const aiBaseUrlInput = document.getElementById('ai-base-url');
            const aiModelNameInput = document.getElementById('ai-model-name');
            const aiApiKeyInput = document.getElementById('ai-api-key');
            const aiConfigSubmitBtn = document.getElementById('ai-config-submit-btn');
            const aiConfigCancelBtn = document.getElementById('ai-config-cancel-btn');
            const aiConfigFormTitle = document.getElementById('ai-config-form-title');
            const aiConfigFormMessage = document.getElementById('ai-config-form-message');
            const aiServiceManagementDiv = document.getElementById('ai-service-management'); // Get the container

            // Function to clear and reset the AI config form
            function resetAiConfigForm() {
                aiConfigForm.reset(); // Resets form fields
                aiConfigIdInput.value = ''; // Clear hidden ID
                aiConfigFormTitle.textContent = '添加自定义配置';
                aiConfigSubmitBtn.textContent = '添加自定义配置';
                aiConfigCancelBtn.style.display = 'none';
                aiApiKeyInput.placeholder = '输入您的 API Key (可选，留空表示无需密钥)'; // Reset placeholder
                aiConfigFormMessage.textContent = '';
                aiConfigFormMessage.className = 'form-message';
                // Reset the form's action if it was changed (it wasn't in this setup)
                // aiConfigForm.action = "{{ url_for('ai_service.manage') }}"; 
                // aiConfigForm.method = "post";
            }

            // Handle Cancel Edit button click
            aiConfigCancelBtn.addEventListener('click', resetAiConfigForm);

            // Handle form submission (Add or Edit)
            aiConfigForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                aiConfigFormMessage.textContent = '';
                aiConfigFormMessage.className = 'form-message';

                const configId = aiConfigIdInput.value;
                const isEditing = !!configId;

                const formData = {
                    name: aiNameInput.value.trim(),
                    service_type: aiServiceTypeSelect.value,
                    base_url: aiBaseUrlInput.value.trim(),
                    model_name: aiModelNameInput.value.trim(),
                    api_key: aiApiKeyInput.value // Send the key, even if empty (backend decides update logic)
                };

                // Basic validation (should match backend eventually)
                if (!formData.name || !formData.service_type || !formData.base_url || !formData.model_name) {
                     showAiConfigMessage('名称、服务类型、基础 URL 和模型名称不能为空。', 'error');
                     return;
                 }
                 
                let url, method;
                if (isEditing) {
                    url = `/api/ai-services/${configId}`;
                    method = 'PUT';
                } else {
                    // Adding uses the original form POST to the manage route
                    // We just let the default form submission happen for adding
                    // Or, uncomment below to use an API endpoint for adding too
                     url = "{{ url_for('ai_service.manage') }}"; // Keep using the manage route for POST
                     method = 'POST'; 
                     // --- If using an API endpoint for adding: ---
                     // url = '/api/ai-services'; 
                     // method = 'POST';
                     // --- End API endpoint for adding ---
                     
                     // For standard POST, we don't need fetch, just submit the form.
                     // However, to show messages consistently, we can use fetch for POST too.
                     // Let's stick to the original POST for now unless problems arise.
                      aiConfigForm.submit(); // Submit the form normally for adding
                      return; // Stop JS execution for standard POST
                }
                
                // --- Fetch logic for PUT (Editing) --- 
                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            // Add CSRF token if needed
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || `HTTP error ${response.status}`);
                    }

                    showAiConfigMessage(isEditing ? '配置更新成功！' : '配置添加成功！', 'success');
                    resetAiConfigForm();
                    // Refresh page to see changes (simplest approach)
                    window.location.reload();
                    // TODO: Update table row dynamically for better UX

                } catch (error) {
                    console.error('AI 配置保存失败:', error);
                    showAiConfigMessage(`保存失败: ${error.message}`, 'error');
                }
            });

            function showAiConfigMessage(message, type = 'info') {
                aiConfigFormMessage.textContent = message;
                aiConfigFormMessage.className = `form-message form-message-${type}`;
            }

            // --- Active Config Selection Handling ---
            if (aiServiceManagementDiv) {
                aiServiceManagementDiv.addEventListener('change', async (event) => {
                    if (event.target.type === 'radio' && event.target.name === 'active_ai_config') {
                        const selectedConfigId = event.target.value;
                        console.log('Selected active config:', selectedConfigId);
                        
                        // Show immediate feedback (optional)
                        showAiConfigMessage('正在更新启用的配置...', 'info'); 

                        try {
                            const response = await fetch('/api/user/settings/active-ai-service', {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    // Add CSRF token if needed
                                },
                                body: JSON.stringify({ config_id: selectedConfigId })
                            });

                            const result = await response.json();

                            if (!response.ok) {
                                throw new Error(result.error || `HTTP error ${response.status}`);
                            }
                            
                            // Show success message (e.g., using a flash message area or the form message area)
                            // alert(result.message); // Simple alert
                            showAiConfigMessage(result.message, 'success');
                            // No page reload needed unless other parts depend on it immediately.

                        } catch (error) {
                            console.error('更新启用配置失败:', error);
                            showAiConfigMessage(`更新失败: ${error.message}`, 'error');
                            // Optionally, revert the radio button selection? Needs careful state management.
                        }
                    }
                });
            }

            // --- Table Button Click Handling --- 
            const userConfigsTbody = document.getElementById('user-ai-configs-tbody');
            const systemConfigsTbody = document.getElementById('system-ai-configs-tbody'); 

            function handleTableClick(event) {
                const target = event.target;
                const configId = target.dataset.id;
                const configName = target.dataset.name;

                if (!configId) return;

                // Handle Edit Button
                if (target.classList.contains('ai-edit-btn')) {
                    event.preventDefault();
                    const row = target.closest('tr');
                    if (!row) return;

                    // Fetch full config details (API Key won't be returned)
                    // We need the details to populate the form.
                    // Let's find the data from the table row itself for simplicity,
                    // assuming all needed fields are visible or stored somewhere accessible.
                    // Note: API Key cannot be fetched this way.
                    
                    // Extract data directly from table cells (adjust indices if table structure changes)
                    const cells = row.cells;
                    const currentData = {
                        id: cells[0].textContent,
                        name: cells[1].textContent,
                        service_type: cells[2].textContent,
                        model_name: cells[3].textContent,
                        base_url: cells[4].textContent,
                        // owner: cells[5] ? cells[5].textContent : null // For system table
                    };

                    // Populate the form
                    aiConfigIdInput.value = currentData.id;
                    aiNameInput.value = currentData.name;
                    aiServiceTypeSelect.value = currentData.service_type;
                    aiBaseUrlInput.value = currentData.base_url;
                    aiModelNameInput.value = currentData.model_name;
                    aiApiKeyInput.value = ''; // Clear API key field when editing
                    aiApiKeyInput.placeholder = '保持不变或输入新 API Key'; // Change placeholder

                    // Update form title and button text
                    aiConfigFormTitle.textContent = `编辑配置 #${currentData.id}`;
                    aiConfigSubmitBtn.textContent = '保存更改';
                    aiConfigCancelBtn.style.display = 'inline-block'; // Show cancel button
                    
                    aiConfigForm.scrollIntoView({ behavior: 'smooth' });
                    aiConfigFormMessage.textContent = ''; // Clear previous messages
                }
                // Handle Make System Preset Button (Admin Only)
                else if (isAdmin && target.classList.contains('make-system-link')) {
                    event.preventDefault(); 
                    if (confirm(`确定要将配置 "${configName}" 设为系统预设服务吗？\n此操作会使其对所有用户可见，但您仍是所有者。`)) {
                        makeConfigSystem(configId, configName);
                    }
                }
                // Handle Delete System Config Button (Admin Only)
                else if (isAdmin && target.classList.contains('system-delete-btn')) {
                    event.preventDefault();
                    if (confirm(`确定要永久删除系统预设配置 "${configName}" 吗？\n此操作不可撤销！`)) {
                         deleteConfig(configId, configName);
                    }
                }
                // Note: User config delete uses standard link/route, not handled here.
            }

            // Add listeners to both table bodies
            if (userConfigsTbody) {
                userConfigsTbody.addEventListener('click', handleTableClick);
            }
            if (systemConfigsTbody) {
                systemConfigsTbody.addEventListener('click', handleTableClick);
            }
            
            // --- Helper Functions for API calls ---
            async function makeConfigSystem(configId, configName) {
                 try {
                    const response = await fetch(`/api/ai-services/${configId}/make-system`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || `HTTP error ${response.status}`);
                    alert(result.message || '操作成功！');
                    window.location.reload(); 
                } catch (error) {
                    console.error('设置系统服务失败:', error);
                    alert(`操作失败: ${error.message}`);
                }
            }

            async function deleteConfig(configId, configName) {
                try {
                    const response = await fetch(`/api/ai-services/${configId}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || `HTTP error ${response.status}`);
                    alert(result.message || '配置已删除。');
                    window.location.reload(); 
                } catch (error) {
                    console.error('删除配置失败:', error);
                    alert(`删除失败: ${error.message}`);
                }
            }

            // --- Prompt Template Management (existing JS, ensure it uses isAdmin correctly) --- 
            const templateTbody = document.getElementById('prompt-templates-tbody');
            const templateEditorDiv = document.getElementById('prompt-template-editor'); // Get the editor div
            const templateForm = document.getElementById('prompt-template-form');
            const templateIdInput = document.getElementById('template-id');
            const templateNameInput = document.getElementById('template-name');
            const templateStringInput = document.getElementById('template-string');
            const templateIsDefaultInput = document.getElementById('template-is-default');
            const clearFormButton = document.getElementById('clear-template-form');
            const formMessageDiv = document.getElementById('template-form-message');

            // Fetch and display templates (modified to show type and handle admin actions)
            async function fetchAndDisplayTemplates() {
                templateTbody.innerHTML = `<tr><td colspan="5">加载中...</td></tr>`; 
                try {
                    const response = await fetch('/api/prompt-templates');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const templates = await response.json();

                    templateTbody.innerHTML = '';
                    if (templates.length === 0) {
                         templateTbody.innerHTML = `<tr><td colspan="5">暂无模板。</td></tr>`;
                    } else {
                        templates.forEach(template => {
                            const row = templateTbody.insertRow();
                            const isSystemTemplate = template.user_id === null;
                            const templateType = isSystemTemplate ? '系统' : '我的';
                            
                            // Determine actions based on admin status and template type
                            let actionCellHtml = '';
                            if (isAdmin) {
                                actionCellHtml = `
                                    <button class="edit-btn" data-id="${template.id}">编辑</button>
                                    <button class="delete-btn" data-id="${template.id}">删除</button>
                                `;
                            } else if (!isSystemTemplate) {
                                // Non-admin seeing their own template
                                actionCellHtml = `
                                    <button class="edit-btn" data-id="${template.id}">编辑</button>
                                    <button class="delete-btn" data-id="${template.id}">删除</button>
                                `;
                            }
                            // No buttons shown for system templates to non-admins
                            
                            row.innerHTML = `
                                <td>${escapeHtml(template.name)}</td>
                                <td class="template-preview">${escapeHtml(template.template_string)}</td>
                                <td>${template.is_default ? '是' : '否'}</td>
                                <td>${templateType}</td>
                                <td>${actionCellHtml || '-'}</td> <!-- Show hyphen if no actions -->
                            `;
                        });
                    }
                } catch (error) {
                    console.error('获取模板列表失败:', error);
                    templateTbody.innerHTML = `<tr><td colspan="5" style="color: red;">加载模板失败，请检查网络或联系管理员。</td></tr>`;
                }
            }

            // Form submit logic (only active for admin)
            if (isAdmin && templateForm) {
                templateForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    formMessageDiv.textContent = '';
                    formMessageDiv.className = 'form-message';

                    const templateId = templateIdInput.value;
                    const name = templateNameInput.value.trim();
                    const templateString = templateStringInput.value;
                    // Default status can only be set by admin (handled server-side, but we send it)
                    const isDefault = templateIsDefaultInput.checked; 

                    if (!name || !templateString) {
                        showFormMessage('模板名称和内容不能为空。', 'error');
                        return;
                    }

                    const url = templateId ? `/api/prompt-templates/${templateId}` : '/api/prompt-templates';
                    const method = templateId ? 'PUT' : 'POST';

                    try {
                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ 
                                name: name, 
                                template_string: templateString, 
                                is_default: isDefault // Send the checkbox status
                            }),
                        });

                        const result = await response.json();

                        if (!response.ok) {
                            throw new Error(result.error || `HTTP error! status: ${response.status}`);
                        }

                        showFormMessage(`模板 "${escapeHtml(name)}" 保存成功！`, 'success');
                        clearTemplateForm();
                        fetchAndDisplayTemplates(); // Refresh list

                    } catch (error) {
                        console.error('保存模板失败:', error);
                        showFormMessage(`保存失败: ${error.message}`, 'error');
                    }
                });
            } // End if (isAdmin && templateForm)

            // Table button click logic (edit/delete)
            templateTbody.addEventListener('click', async (event) => {
                 const target = event.target;
                 const templateId = target.dataset.id;

                 if (!templateId) return;

                 const canPerformAction = isAdmin || target.closest('tr').querySelector('td:nth-child(4)').textContent === '我的';

                 if (target.classList.contains('edit-btn') && canPerformAction) {
                      try {
                         const response = await fetch(`/api/prompt-templates/${templateId}`);
                          if (!response.ok) {
                             throw new Error(`HTTP error! status: ${response.status}`);
                         }
                         const template = await response.json();
                         
                         // Check again if admin or owner before populating form
                         const isSystemTemplate = template.user_id === null;
                         if (isAdmin || (!isSystemTemplate && template.user_id /* check if user id matches current? */)) {
                             templateIdInput.value = template.id;
                             templateNameInput.value = template.name;
                             templateStringInput.value = template.template_string;
                             // Only admin should be able to effectively change default status via UI?
                             templateIsDefaultInput.checked = template.is_default; 
                             templateIsDefaultInput.disabled = !isAdmin; // Disable checkbox if not admin

                             templateForm.style.display = 'block'; // Ensure form is visible
                             templateForm.scrollIntoView({ behavior: 'smooth' }); 
                             formMessageDiv.textContent = '';
                         } else {
                              alert('您无权编辑此模板。')
                         }
                     } catch (error) {
                          console.error('获取模板详情失败:', error);
                          alert('加载模板信息失败，请重试。');
                     }
                 }
                 else if (target.classList.contains('delete-btn') && canPerformAction) {
                      const templateRow = target.closest('tr');
                      const templateName = templateRow.cells[0].textContent;

                     if (confirm(`确定要删除模板 "${templateName}" 吗？`)) {
                         try {
                             const response = await fetch(`/api/prompt-templates/${templateId}`, {
                                 method: 'DELETE',
                             });

                             if (!response.ok) {
                                 let errorMsg = `HTTP error! status: ${response.status}`;
                                 try {
                                     const errData = await response.json();
                                     errorMsg = errData.error || errorMsg;
                                 } catch(e) {}
                                 throw new Error(errorMsg);
                             } 

                             alert(`模板 "${templateName}" 已删除。`);
                             fetchAndDisplayTemplates(); // Refresh list
                             if (templateIdInput.value === templateId) {
                                 clearTemplateForm();
                             }

                         } catch (error) {
                             console.error('删除模板失败:', error);
                             alert(`删除失败: ${error.message}`);
                         }
                     }
                 }
            });
            
            // Clear form button (only active for admin)
            if (isAdmin && clearFormButton) {
                 clearFormButton.addEventListener('click', clearTemplateForm);
            }
            
            function clearTemplateForm() {
                if (isAdmin) {
                    templateForm.reset();
                    templateIdInput.value = '';
                    templateIsDefaultInput.disabled = false; // Re-enable checkbox
                    formMessageDiv.textContent = '';
                    formMessageDiv.className = 'form-message';
                }
            }

            function showFormMessage(message, type = 'info') {
                formMessageDiv.textContent = message;
                formMessageDiv.className = `form-message form-message-${type}`;
            }

            function escapeHtml(unsafe) {
                if (unsafe === null || typeof unsafe === 'undefined') return '';
                return unsafe
                    .toString()
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            // Initial load
            fetchAndDisplayTemplates();

            // --- AI Service Right Collapsible Panel Logic ---
            const aiServicePanel = document.getElementById('ai-service-right-panel');
            const aiPanelToggleHandle = aiServicePanel ? aiServicePanel.querySelector('.ai-panel-toggle-handle') : null;
            // const aiPanelActualContent = aiServicePanel ? aiServicePanel.querySelector('.ai-panel-actual-content') : null; // Not directly used for toggle
            let aiPanelContentLoaded = false; // Example flag if content loading is needed

            if (aiServicePanel && aiPanelToggleHandle) {
                aiPanelToggleHandle.addEventListener('click', function() {
                    const willBeExpanded = !aiServicePanel.classList.contains('expanded');
                    aiServicePanel.classList.toggle('expanded');
                    // Example: Load content if expanding for the first time
                    if (willBeExpanded && !aiPanelContentLoaded) {
                        // console.log('AI Service panel expanded for the first time. Load content here if needed.');
                        // loadAiPanelContent(); // Hypothetical function
                        aiPanelContentLoaded = true;
                    }
                });

                // Optional: Check if panel should be expanded by default (e.g., via saved state or a class)
                // if (aiServicePanel.classList.contains('expanded') && !aiPanelContentLoaded) {
                //    loadAiPanelContent();
                //    aiPanelContentLoaded = true;
                // }
            }

            // --- User AI Preferences UI Logic ---
            const bgColorR = document.getElementById('ai-bg-color-r');
            const bgColorG = document.getElementById('ai-bg-color-g');
            const bgColorB = document.getElementById('ai-bg-color-b');
            const fontColorR = document.getElementById('ai-font-color-r');
            const fontColorG = document.getElementById('ai-font-color-g');
            const fontColorB = document.getElementById('ai-font-color-b');
            const stylePreview = document.getElementById('ai-style-preview');
            const retryPromptTextarea = document.getElementById('retry-prompt-template');
            const enableMarkdownCheckbox = document.getElementById('enable-markdown-prompt');
            const markdownPromptTextarea = document.getElementById('markdown-prompt-template');
            const statusMessageDiv = document.getElementById('ai-prefs-status-message');

            function updatePreviewStyle() {
                if (!bgColorR || !bgColorG || !bgColorB || !fontColorR || !fontColorG || !fontColorB || !stylePreview) {
                    console.warn("One or more style preference elements are missing.");
                    return;
                }
                const bgR = bgColorR.value || 0;
                const bgG = bgColorG.value || 0;
                const bgB = bgColorB.value || 0;
                const fontR = fontColorR.value || 0;
                const fontG = fontColorG.value || 0;
                const fontB = fontColorB.value || 0;

                stylePreview.style.backgroundColor = `rgb(${bgR}, ${bgG}, ${bgB})`;
                stylePreview.style.color = `rgb(${fontR}, ${fontG}, ${fontB})`;
            }

            function showStatusMessage(message, type = 'info') {
                if (!statusMessageDiv) return;
                statusMessageDiv.textContent = message;
                statusMessageDiv.className = `form-message form-message-${type}`; // Use general form-message for base styling
                statusMessageDiv.classList.add(type); // Add specific type for color
                statusMessageDiv.style.display = 'block';
                setTimeout(() => {
                    statusMessageDiv.style.display = 'none';
                    statusMessageDiv.textContent = '';
                    statusMessageDiv.className = 'form-message';
                }, 4000);
            }

            async function loadUserAiPreferences() {
                console.log("Attempting to load user AI preferences...");
                try {
                    const response = await fetch('/api/user/ai-preferences');
                    if (!response.ok) {
                        if (response.status === 404) { // Preferences not yet set for user
                            console.log("User AI preferences not found (404), using current form/default values.");
                            showStatusMessage('未找到用户偏好设置，将使用默认值。您可随时保存您的设置。', 'info');
                            updatePreviewStyle(); // Ensure preview is updated with form defaults
                            return; // Keep existing form values as defaults
                        }
                        throw new Error(`获取偏好设置失败: ${response.status}`);
                    }
                    const prefs = await response.json();
                    console.log("Preferences loaded:", prefs);

                    if (prefs) {
                        bgColorR.value = prefs.ai_bg_color_r !== null ? prefs.ai_bg_color_r : 255;
                        bgColorG.value = prefs.ai_bg_color_g !== null ? prefs.ai_bg_color_g : 240;
                        bgColorB.value = prefs.ai_bg_color_b !== null ? prefs.ai_bg_color_b : 240;
                        
                        // --- Fix: Add loading for font color values --- 
                        fontColorR.value = prefs.ai_font_color_r !== null ? prefs.ai_font_color_r : 51;
                        fontColorG.value = prefs.ai_font_color_g !== null ? prefs.ai_font_color_g : 51;
                        fontColorB.value = prefs.ai_font_color_b !== null ? prefs.ai_font_color_b : 51;
                        // --- End Fix ---

                        retryPromptTextarea.value = prefs.retry_prompt_template || '';
                        enableMarkdownCheckbox.checked = prefs.enable_markdown_prompt || false;
                        markdownPromptTextarea.value = prefs.markdown_prompt_template || '';
                        
                        updatePreviewStyle();
                        showStatusMessage('用户偏好设置已加载。', 'success');
                    } else {
                         // This case might not be hit if 404 is handled above, but good as a fallback
                        console.log("No preferences data returned, using current form/default values.");
                        updatePreviewStyle();
                    }
                } catch (error) {
                    console.error('加载用户偏好设置时出错:', error);
                    showStatusMessage(`加载偏好设置错误: ${error.message}`, 'error');
                    updatePreviewStyle(); // Still update preview with form defaults on error
                }
            }

            if (bgColorR && bgColorG && bgColorB && fontColorR && fontColorG && fontColorB) {
                [bgColorR, bgColorG, bgColorB, fontColorR, fontColorG, fontColorB].forEach(input => {
                    input.addEventListener('input', updatePreviewStyle);
                    input.addEventListener('change', updatePreviewStyle); // For up/down arrows
                });
                 // Initial preview update
                updatePreviewStyle();
            }

            // Placeholder for save button functionality
            const savePrefsBtn = document.getElementById('save-user-ai-prefs-btn');
            if (savePrefsBtn) {
                savePrefsBtn.addEventListener('click', async () => {
                    const payload = {
                        ai_bg_color_r: parseInt(bgColorR.value) || 0,
                        ai_bg_color_g: parseInt(bgColorG.value) || 0,
                        ai_bg_color_b: parseInt(bgColorB.value) || 0,
                        ai_font_color_r: parseInt(fontColorR.value) || 0,
                        ai_font_color_g: parseInt(fontColorG.value) || 0,
                        ai_font_color_b: parseInt(fontColorB.value) || 0,
                        retry_prompt_template: retryPromptTextarea.value,
                        enable_markdown_prompt: enableMarkdownCheckbox.checked,
                        markdown_prompt_template: markdownPromptTextarea.value
                    };

                    console.log("Saving preferences:", payload);
                    showStatusMessage('正在保存设置...', 'info');

                    try {
                        const response = await fetch('/api/user/ai-preferences', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({ error: `HTTP error ${response.status}` }));
                            throw new Error(errorData.error || `保存失败: ${response.status}`);
                        }
                        const result = await response.json();
                        showStatusMessage(result.message || '用户偏好设置已保存。', 'success');
                        console.log("Save successful:", result);
                    } catch (error) {
                        console.error('保存偏好设置时出错:', error);
                        showStatusMessage(`保存错误: ${error.message}`, 'error');
                    }
                });
            }

            const defaultPrefsBtn = document.getElementById('use-default-ai-prefs-btn');
            if (defaultPrefsBtn) {
                defaultPrefsBtn.addEventListener('click', async () => {
                    // alert('使用默认设置的功能将在后续实现。');
                    showStatusMessage('正在加载系统默认配置...', 'info');
                    try {
                        const response = await fetch('/api/user/ai-preferences/system-default');
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({ error: `获取默认配置失败: ${response.status}`}));
                            throw new Error(errorData.error);
                        }
                        const defaults = await response.json();
                        
                        // Populate form with defaults
                        bgColorR.value = defaults.ai_bg_color_r !== null ? defaults.ai_bg_color_r : 255;
                        bgColorG.value = defaults.ai_bg_color_g !== null ? defaults.ai_bg_color_g : 240;
                        bgColorB.value = defaults.ai_bg_color_b !== null ? defaults.ai_bg_color_b : 240;
                        fontColorR.value = defaults.ai_font_color_r !== null ? defaults.ai_font_color_r : 51;
                        fontColorG.value = defaults.ai_font_color_g !== null ? defaults.ai_font_color_g : 51;
                        fontColorB.value = defaults.ai_font_color_b !== null ? defaults.ai_font_color_b : 51;
                        
                        retryPromptTextarea.value = defaults.retry_prompt_template || '';
                        enableMarkdownCheckbox.checked = defaults.enable_markdown_prompt || false;
                        markdownPromptTextarea.value = defaults.markdown_prompt_template || '';
                        
                        updatePreviewStyle(); // Update color preview
                        showStatusMessage('系统默认配置已加载到表单。请按需保存为您的个人设置。', 'success');

                    } catch (error) {
                        console.error('加载系统默认配置时出错:', error);
                        showStatusMessage(`加载默认配置错误: ${error.message}`, 'error');
                    }
                });
            }

            // Initial load of preferences when the panel content is ready
            if (aiServicePanel && aiPanelToggleHandle) { // Check if panel elements exist
                loadUserAiPreferences(); 
            }

            // Admin-specific UI elements
            const adminOnlyActionsDiv = document.getElementById('admin-only-actions');
            // const isAdmin = mainContentDataDiv ? mainContentDataDiv.dataset.isAdmin === 'true' : false; // REMOVE REDECLARATION

            if (isAdmin && adminOnlyActionsDiv) { // REUSE isAdmin from above
                adminOnlyActionsDiv.style.display = 'block'; // Show admin buttons
                
                const exportBtn = document.getElementById('export-system-defaults-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', async () => {
                        if (!confirm('确定要将当前右侧面板的AI偏好设置导出为新的系统默认配置吗？这将覆盖之前的系统默认配置。')) {
                            return;
                        }

                        const payload = {
                            ai_bg_color_r: parseInt(bgColorR.value) || 0,
                            ai_bg_color_g: parseInt(bgColorG.value) || 0,
                            ai_bg_color_b: parseInt(bgColorB.value) || 0,
                            ai_font_color_r: parseInt(fontColorR.value) || 0,
                            ai_font_color_g: parseInt(fontColorG.value) || 0,
                            ai_font_color_b: parseInt(fontColorB.value) || 0,
                            retry_prompt_template: retryPromptTextarea.value,
                            enable_markdown_prompt: enableMarkdownCheckbox.checked,
                            markdown_prompt_template: markdownPromptTextarea.value
                        };
                        showStatusMessage('正在导出系统默认配置...', 'info');
                        try {
                            const response = await fetch('/api/admin/ai-preferences/system-default', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            const result = await response.json();
                            if (!response.ok) {
                                throw new Error(result.error || `导出失败: ${response.status}`);
                            }
                            showStatusMessage(result.message || '系统默认配置已更新。', 'success');
                        } catch (error) {
                            console.error('导出系统默认配置时出错:', error);
                            showStatusMessage(`导出错误: ${error.message}`, 'error');
                        }
                    });
                }
            }

        });
    </script>

</body>
</html> 