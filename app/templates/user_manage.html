<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>用户管理</title>
    <link rel="stylesheet" href="/static/style.css">
     <!-- 引入 Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Reset default body margin */
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif; /* Updated Font */
            margin: 0; /* Remove default margin */
            background-color: #f7f7f7; /* Match index.html body background */
            padding-top: 60px; /* Keep padding for fixed top bar height */
            overflow-x: hidden; /* Prevent horizontal scroll if panel is too wide briefly during transition */
        }

        /* Top Bar Styles (Aligned with style.css/.top-bar in index.html) */
        .top-bar {
            background: #444; /* Match index.html top-bar */
            /* color: #fff; */ /* Inherited */
            padding: 0 20px; /* Match index.html top-bar padding */
            display: flex;
            justify-content: space-between; /* Adjust to allow left/right controls */
            align-items: center;
            height: 60px; /* Match index.html top-bar height */
            position: fixed; /* Make it fixed */
            top: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box; /* Include padding in width/height */
            z-index: 1001; /* Ensure it's above other content */
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); /* Match index.html top-bar shadow */
        }
        .top-bar .right-buttons { /* Keep if needed, adjust gap */
            display: flex;
            gap: 15px; /* Match index.html gap? */
            margin-left: auto; /* Push right */
        }
        .top-bar .left-controls {
             /* margin-right: auto; */ /* Removed, handled by justify-content: space-between */
             display: flex;
             align-items: center;
             gap: 15px; /* Match index.html gap? */
        }
        /* Timezone selector styling */
        .timezone-selector-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 15px; /* Add some space before right buttons */
        }
        .timezone-selector-container label {
            color: #e0e0e0; /* Lighter text for label */
            font-size: 14px;
            margin-bottom: 0; /* Override default label margin */
            font-weight: normal;
        }
        #timezone-selector {
            padding: 4px 8px;
            border: 1px solid #666;
            border-radius: 4px;
            background-color: #555;
            color: #fff;
            font-size: 13px;
            max-width: 200px; /* Prevent it from becoming too wide */
        }
        #timezone-selector:focus {
            outline: none;
            border-color: #aaa;
            box-shadow: 0 0 3px rgba(255, 255, 255, 0.3);
        }

        /* .top-btn is defined in style.css, reuse that class for consistency */
        /* Remove redundant .top-btn style here if style.css is loaded */
         /* Example: Keep minimal override if needed */
        .top-bar .top-btn {
             /* Inherits from style.css */
             /* Optionally add specific overrides here if needed */
             /* Example: font-size: 16px; */
        }
        /* Remove hover if defined in style.css */
        /* .top-btn:hover {
             background-color: #777;
        } */

        /* Main Content Container (Adjusted) */
        .container {
            max-width: 1000px;
            margin: 20px auto;
            /* background: #fff; */ /* Remove background to blend with body */
            background: #fdfdfd; /* Slightly off-white if blending is not desired */
            padding: 30px;
            border-radius: 8px;
            /* box-shadow: 0 2px 10px rgba(0,0,0,0.1); */ /* Adjust or remove shadow */
            box-shadow: 0 1px 5px rgba(0,0,0,0.06); /* Softer shadow */
        }

        /* Headers */
        h1, h2 { color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;}

        /* Table Styles (Minor adjustments for consistency) */
        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        th, td { border: 1px solid #ddd; padding: 10px 12px; text-align: left; vertical-align: middle; }
        th { background-color: #e9eef2; /* Match left sidebar header? */ font-weight: bold; color: #444; }
        tr:nth-child(even) { background-color: #f8f9fa; /* Slightly lighter alternate */ }
        td.actions-cell {
            display: flex;
            align-items: center;
            gap: 8px; /* Slightly reduce gap */
            flex-wrap: wrap;
        }

        /* Flash Messages (Keep as is or adjust colors slightly) */
        .flash-messages { list-style: none; padding: 0; margin-bottom: 20px; }
        .flash-messages li { padding: 10px 15px; margin-bottom: 10px; border-radius: 4px; }
        .flash-messages .success { background-color: #d1e7dd; color: #0f5132; border: 1px solid #a3cfbb; } /* Match save success green */
        .flash-messages .error { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; } /* Match delete red */

        /* Action Button Styles (Align with index.html buttons) */
        .action-btn {
            padding: 5px 12px; /* Adjust padding */
            border: 1px solid #ccc;
            border-radius: 5px; /* Match index.html radius */
            cursor: pointer;
            background-color: #f0f0f0; /* Default background */
            color: #333; /* Default text color */
            font-size: 13px;
            text-decoration: none;
            display: inline-block;
            /* margin-left: 5px; */ /* Use gap in parent instead */
            vertical-align: middle;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .action-btn:hover {
            background-color: #e0e0e0;
            border-color: #bbb;
        }
        .delete-btn { /* Specific style for delete */
            background-color: #f8d7da; /* Light red */
            border-color: #f5c2c7;
            color: #842029; /* Dark red text */
        }
        .delete-btn:hover {
             background-color: #e5a4aa;
             border-color: #e08b93;
        }

        /* Grant Form Styles */
        .grant-form {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .grant-form input[type="number"] {
            width: 60px;
            padding: 5px 8px; /* Match button padding */
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 13px;
        }
        .grant-form button { /* Style like other action buttons */
            /* background-color: #28a745; */ /* Use success color */
            background-color: #d1e7dd; /* Light green */
            border-color: #a3cfbb;
            color: #0f5132;
            /* padding: 4px 8px; */ /* Use action-btn padding */
            /* font-size: 12px; */ /* Use action-btn font-size */
        }
        .grant-form button:hover {
            background-color: #bcdfca;
            border-color: #8cccac;
        }

        /* General Form Styles */
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        input[type="text"], input[type="password"] {
            width: calc(100% - 22px); /* Account for padding/border */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px; /* Match button radius */
            font-size: 14px; /* Consistent font size */
        }
        .form-group { margin-bottom: 20px; }
        .form-button { /* Style like primary action button */
             /* background-color: #007bff; */ /* Use a consistent primary color */
             background-color: #cfe2ff; /* Light blue */
             border: 1px solid #b6d4fe;
             color: #084298; /* Dark blue text */
             padding: 8px 15px; /* Adjust padding */
             /* border: none; */
             border-radius: 5px;
             cursor: pointer;
             font-size: 14px; /* Consistent font size */
             transition: background-color 0.2s, border-color 0.2s;
        }
        .form-button:hover {
             background-color: #a6caff;
             border-color: #8cbefd;
        }
        /* .back-link { display: inline-block; margin-bottom: 20px; color: #007bff; text-decoration: none; } */
        /* .back-link:hover { text-decoration: underline; } */ /* Replaced by top-bar button */

        /* Collapsible Section Styles */
        .collapsible-section {
            margin-bottom: 20px;
            border: 1px solid #eee;
            border-radius: 6px;
            overflow: hidden; /* Ensure children stay within rounded corners */
        }
        .collapsible-section summary {
            cursor: pointer;
            padding: 12px 15px; /* Increase padding */
            font-weight: bold;
            list-style: none; /* Remove default marker */
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #f8f9fa; /* Light header background */
            border-bottom: 1px solid #eee; /* Separator line */
        }
        .collapsible-section summary:hover {
            background-color: #f1f3f5;
        }
        .collapsible-section summary::-webkit-details-marker { display: none; } /* Hide marker in Webkit */
        .collapsible-section summary::before {
            content: '\f078'; /* Corrected: Font Awesome down arrow with single backslash */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            transition: transform 0.2s;
            display: inline-block;
            margin-right: 5px;
            color: #666; /* Arrow color */
        }
        .collapsible-section[open] summary {
             border-bottom: 1px solid #eee; /* Keep border when open */
        }
        .collapsible-section[open] summary::before {
            transform: rotate(-180deg);
        }
        .collapsible-content {
            /* padding-left: 20px; */
            /* border-left: 2px solid #eee; */
            /* margin-left: 5px; */
            /* margin-top: 10px; */
            padding: 20px; /* Add padding to content area */
            background-color: #fff; /* White background for content */
        }

        /* Group Management Styles */
        .group-management {
            /* margin-top: 40px; */ /* Removed, handled by collapsible content padding */
            /* border-top: 1px solid #eee; */ /* Removed, handled by collapsible structure */
            /* padding-top: 20px; */ /* Removed */
        }
        .group-list { margin-top: 20px; }
        .group-item details {
            /* background-color: #f9f9f9; */
            background-color: #fff; /* Use white */
            border: 1px solid #e0e0e0; /* Slightly darker border */
            border-radius: 5px;
            margin-bottom: 10px;
            /* padding: 10px 15px; */ /* Padding applied to summary/content */
        }
        .group-item summary {
             font-weight: bold;
             display: flex;
             justify-content: space-between;
             align-items: center;
             list-style: none;
             padding: 10px 15px; /* Consistent padding */
             background-color: #f8f8f8; /* Light gray header for group item */
             border-bottom: 1px solid #e0e0e0; /* Separator */
        }
        .group-item summary:hover {
             background-color: #f0f0f0;
        }
        .group-item details[open] summary {
            border-bottom: 1px solid #e0e0e0; /* Keep separator when open */
        }
        .group-item summary::-webkit-details-marker { display: none; }
        .group-actions button {
             /* margin-left: 8px; */ /* Use gap */
             /* font-size: 12px; */ /* Use action-btn style */
             /* padding: 3px 8px; */ /* Use action-btn style */
        }
        .group-actions { /* Container for buttons */
             display: flex;
             gap: 5px;
        }
        .group-members {
             /* margin-top: 15px; */
             padding: 15px; /* Padding inside group content */
             /* padding-left: 15px; */
        }
        .group-members h4 { margin-top: 0; margin-bottom: 10px; color: #555; }
        .group-members ul { list-style: none; padding-left: 0; margin: 10px 0; } /* Remove disc, use spacing */
        .group-members li {
             margin-bottom: 8px;
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 5px 0; /* Add vertical padding */
             border-bottom: 1px dashed #eee; /* Separator */
        }
         .group-members li:last-child {
             border-bottom: none; /* Remove border for last item */
         }
        .group-members button.remove-user-btn {
             /* background-color: #ffc107; */ /* Use warning colors */
             background-color: #fff3cd;
             border: 1px solid #ffe69c;
             color: #664d03;
             /* font-size: 11px; */ /* Use action-btn style */
             /* padding: 2px 6px; */ /* Use action-btn style */
        }
        .group-members button.remove-user-btn:hover {
             background-color: #ffeeba;
             border-color: #ffdf7e;
        }
        .add-user-to-group-form {
             margin-top: 15px; /* Space above add form */
             display: flex;
             gap: 8px;
             align-items: center;
        }
        .add-user-to-group-form input[type="text"] {
             width: 180px; /* Slightly wider */
             padding: 8px 10px; /* Match form-button padding */
             margin-bottom: 0;
             font-size: 14px; /* Match form-button font-size */
             border-radius: 5px;
        }
        .add-user-to-group-form button { /* Use form-button style */
             /* font-size: 13px; */
             /* padding: 5px 10px; */
             /* Add class="form-button" in HTML instead */
        }
        .group-name-display {
            flex-grow: 1;
            margin-right: 10px;
            color: #333; /* Ensure good contrast */
        }

        /* Right Collapsible Panel Styles - Revised for Fixed Positioning and Overlay */
        #subscription-panel {
            /* width: 320px; */ /* Default fixed width removed, now percentage based when expanded */
            height: calc(100vh - 60px); /* Full height below top-bar */
            position: fixed; 
            right: 0;
            top: 60px; 
            background-color: #f8f9fa; 
            border-left: 1px solid #e0e0e0;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1); /* Shadow on the left side */
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out; /* Keep width transition */
            overflow: hidden; 
            z-index: 999; /* Below modals (usually 1000+), above normal content */
            transform: translateX(calc(100% - 100px)); /* Initially collapsed, showing 100px */
        }

        #subscription-panel.expanded {
            transform: translateX(0); /* Slides in to be fully visible */
            width: 40%; /* Expanded width is 40% of viewport */
        }

        .panel-toggle-handle {
            width: 45px; 
            height: 100%;
            position: absolute; /* Position handle within the panel */
            left: 0; /* Stick to the left edge of the panel */
            top: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background-color: #e9eef2;
            border-right: 1px solid #d0d7de; /* Border on the right of handle */
            box-sizing: border-box;
        }
        
        #subscription-panel.expanded .panel-toggle-handle {
             background-color: #dde3e8;
        }

        .panel-toggle-handle .panel-handle-text {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            margin-top: 15px;
            font-size: 14px;
            font-weight: bold;
            color: #444;
            white-space: nowrap;
        }

        .panel-toggle-handle #panel-toggle-icon {
            font-size: 16px;
            color: #333;
            transition: transform 0.3s ease-in-out;
        }

        #subscription-panel.expanded .panel-toggle-icon {
            transform: rotate(180deg); 
        }

        .panel-actual-content {
            padding: 20px;
            margin-left: 100px; /* Offset by wider handle area */
            width: calc(100% - 100px); /* Content takes remaining width */
            box-sizing: border-box;
            height: 100%;
            overflow-y: auto;
            /* display: none; /* No longer needed, visibility controlled by panel's transform */
        }

        /* #subscription-panel.expanded .panel-actual-content { */
            /* display: block; /* No longer needed */
        /* } */

        .panel-actual-content h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .panel-actual-content hr {
            border: 0;
            border-top: 1px solid #eee;
            margin: 15px 0;
        }

        /* Styles for Target Group Manager in Modal */
        .target-groups-manager {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            background-color: #f9f9f9;
            margin-top: 5px; /* Add some space above */
        }
        .selected-groups-container {
            margin-bottom: 10px;
            padding: 8px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 30px; /* Ensure it has some height even when empty */
            display: flex;
            flex-wrap: wrap; /* Allow items to wrap */
            gap: 8px; /* Spacing between selected group items */
        }
        .selected-group-item {
            background-color: #e9ecef; /* Lighter gray */
            color: #212529;
            padding: 5px 10px;
            border-radius: 15px; /* Pill shape */
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .remove-group-from-sub-btn {
            background: none;
            border: none;
            color: #6c757d; /* Bootstrap secondary color */
            font-size: 15px; /* Slightly larger for better clickability */
            font-weight: bold;
            cursor: pointer;
            padding: 0 3px; 
            line-height: 1; 
        }
        .remove-group-from-sub-btn:hover {
            color: #dc3545; /* Bootstrap danger color for hover */
        }
        .add-group-to-sub-controls {
            position: relative; 
        }
        .btn-toggle-available-groups {
            /* Use existing .action-btn or .form-button for consistency if desired */
            /* This example makes it a bit more distinct */
            background-color: #0d6efd; /* Bootstrap primary blue */
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-toggle-available-groups:hover {
            background-color: #0b5ed7; /* Darker blue */
        }
        .available-groups-dropdown {
            display: none; /* Hidden by default */
            position: absolute;
            background-color: white;
            border: 1px solid #ced4da; /* Bootstrap form input border */
            border-radius: 4px;
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1050; 
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); /* Bootstrap dropdown shadow */
            margin-top: 5px; /* Space from button */
        }
        .available-group-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid #eee;
            color: #212529;
        }
        .available-group-item:last-child {
            border-bottom: none;
        }
        .available-group-item:hover {
            background-color: #e9ecef; /* Light hover */
        }
        .available-group-item.disabled { 
            color: #adb5bd; /* Bootstrap muted color */
            cursor: not-allowed;
            background-color: #f8f9fa;
        }
        .no-groups-message {
            font-style: italic;
            color: #6c757d;
            font-size: 13px;
            padding: 5px 0; /* Adjusted padding */
            width: 100%; /* Take full width for centering or alignment */
            text-align: center;
        }

        /* Log Viewer Modal Styles */
        #view-logs-modal .modal-content {
            max-width: 800px; /* Wider for logs */
            background-color: #282c34; /* Dark background for modal content area */
            color: #abb2bf; /* Light gray text for modal overall */
        }
        #view-logs-modal h2 {
            color: #61afef; /* Light blue for header */
            border-bottom-color: #3e4451; /* Darker border */
        }
        #logs-content-area {
            background-color: #21252b; /* Slightly darker for pre background */
            color: #dcdfe4; /* Off-white text for logs */
            padding: 15px;
            border-radius: 5px;
            max-height: 60vh; /* Adjusted height, can be tuned */
            overflow-y: auto;
            white-space: pre-wrap; /* Wrap long lines but preserve formatting */
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            font-size: 13px;
            border: 1px solid #3e4451;
            line-height: 1.5; /* Improve readability */
        }
        #clear-logs-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #3e4451;
        }
        #clear-logs-section label {
            color: #abb2bf;
            display: block; /* Make label take full width */
            margin-bottom: 8px;
        }
        #clear-logs-section input[type="password"] {
            background-color: #3e4451;
            color: #dcdfe4;
            border: 1px solid #282c34;
            width: calc(100% - 24px); /* Adjust width considering padding */
            padding: 10px;
            border-radius: 4px;
        }
        /* Ensure close button is visible on dark background */
        #view-logs-modal .close-modal-btn {
            color: #abb2bf;
            text-shadow: 0 1px 0 #000; /* Add shadow for better visibility */
        }
        #view-logs-modal .close-modal-btn:hover {
            color: #fff;
        }
        /* Styling for buttons within the dark modal */
        #view-logs-modal .action-btn.delete-btn {
            background-color: #dc3545; /* Bootstrap danger red */
            color: white;
            border-color: #dc3545;
        }
        #view-logs-modal .action-btn.delete-btn:hover {
            background-color: #c82333; /* Darker red */
            border-color: #bd2130;
        }
        #view-logs-modal .action-btn {
            background-color: #495057; /* Dark gray */
            color: white;
            border-color: #495057;
        }
        #view-logs-modal .action-btn:hover {
            background-color: #343a40; /* Darker gray */
            border-color: #23272b;
        }
        /* Log Table Styles */
        #logs-table-container {
            border: 1px solid #3e4451;
            border-radius: 5px;
            background-color: #21252b; /* Match pre background */
            line-height: 1.5;
        }
        #logs-table {
            width: 100%;
            border-collapse: collapse;
            color: #dcdfe4; /* Match pre text color */
        }
        #logs-table th, #logs-table td {
            border: 1px solid #3e4451; /* Darker border */
            padding: 8px 12px;
            text-align: left;
            font-size: 13px;
            vertical-align: middle;
        }
        #logs-table th {
            background-color: #282c34; /* Modal content background */
            color: #61afef; /* Header color */
            font-weight: bold;
            position: sticky; /* Make header sticky */
            top: 0; /* Stick to the top of the container */
            z-index: 1; /* Ensure header is above table body */
        }
        #logs-table tbody tr:nth-child(even) {
            background-color: #2c313a; /* Slightly lighter row stripe */
        }
        #logs-table tbody tr:hover {
            background-color: #3e4451; /* Hover effect */
        }
        #logs-loading-message { /* Style for loading/empty message */
            color: #abb2bf;
        }

    </style>
</head>
<body>
    {# New Top Bar #}
    <div class="top-bar">
        <div class="left-controls">
            <div class="timezone-selector-container">
                <label for="timezone-selector">发放时区:</label>
                <select id="timezone-selector" name="distribution_timezone">
                    <option value="">加载中...</option>
                </select>
            </div>
        </div>
        <div class="right-buttons">
             <a href="{{ url_for('main.index') }}" class="top-btn">返回主界面</a>
        </div>
    </div>

    {# Existing main content container - should remain centered #}
    <div class="container">
        <h1>用户与邀请码管理</h1>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="flash-messages">
            {% for category, message in messages %}
              <li class="{{ category }}">{{ message }}</li>
            {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        {# 用户列表 (折叠, 默认展开) #}
        <details class="collapsible-section" open>
            <summary><i class="fas fa-users"></i> 用户列表</summary>
            <div class="collapsible-content">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>用户名</th>
                            <th>管理员?</th>
                            <th>点数余额</th>
                            <th>所属组</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td>{{ user.username }}</td>
                            <td>{{ '是' if user.is_admin else '否' }}</td>
                            <td id="points-{{ user.id }}">{{ user.points }}</td>
                            <td>
                                {% if user.groups %}
                                    {{ user.groups | map(attribute='name') | join(', ') }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="actions-cell">
                                {% if not user.is_admin %}
                                    <a href="{{ url_for('user.delete', user_id=user.id) }}" class="action-btn delete-btn" onclick="return confirm('确定要删除用户 {{ user.username }} 吗？');">删除</a>
                                    <form class="grant-form" data-user-id="{{ user.id }}">
                                        <input type="number" min="1" placeholder="点数" required>
                                        <button type="submit" class="action-btn">发放</button>
                                    </form>
                                {% else %}
                                    (管理员)
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </details>

        {# 折叠的添加用户部分 (保持默认关闭) #}
        <details class="collapsible-section">
            <summary><i class="fas fa-user-plus"></i> 添加新用户</summary>
            <div class="collapsible-content">
                <form id="add-user-form" method="POST" action="{{ url_for('user.manage') }}">
                    <div class="form-group">
                        <label for="username">用户名:</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">密码:</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit" class="form-button">添加用户</button>
                </form>
            </div>
        </details>

        {# 用户组管理 (折叠, 默认关闭) #}
        <details class="collapsible-section">
            <summary><i class="fas fa-layer-group"></i> 用户组管理</summary>
            <div class="group-management collapsible-content">
                {# 创建新组表单 #}
                <form id="create-group-form" class="form-group">
                    <label for="new-group-name">创建新组:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-group-name" name="name" placeholder="新用户组名称" required style="margin-bottom: 0; flex-grow: 1;">
                        <button type="submit" class="form-button">创建</button>
                    </div>
                </form>

                {# 现有组列表 #}
                <div class="group-list">
                    <h3>现有用户组:</h3>
                    {% if groups %}
                        {% for group in groups %}
                        <div class="group-item" data-group-id="{{ group.id }}">
                            <details>
                                <summary>
                                    <span class="group-name-display">{{ group.name }}</span>
                                    <div class="group-actions">
                                        <button class="action-btn delete-btn delete-group-btn" onclick="deleteGroup(event, '{{ group.id }}', '{{ group.name }}')">删除此组</button>
                                    </div>
                                </summary>
                                <div class="group-members collapsible-content">
                                    <h4>组成员:</h4>
                                    <ul id="group-members-list-{{ group.id }}">
                                        {% for member in group.users.all() %}
                                        <li data-user-id="{{ member.id }}">
                                            <span>{{ member.username }}</span>
                                            <button class="action-btn remove-user-btn" onclick="removeUserFromGroup(event, '{{ group.id }}', '{{ member.id }}', '{{ member.username }}')">移除</button>
                                        </li>
                                        {% else %}
                                        <li class="no-members">暂无成员</li>
                                        {% endfor %}
                                    </ul>
                                    <form class="add-user-to-group-form" data-group-id="{{ group.id }}">
                                        <input type="text" name="username" placeholder="输入用户名添加" required>
                                        <button type="submit" class="form-button">添加成员</button>
                                    </form>
                                </div>
                            </details>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p>暂无用户组。</p>
                    {% endif %}
                </div>
            </div>
        </details>

        <!-- New Invitation Code Management Section -->
        <details class="collapsible-section" id="invitation-code-section">
            <summary><i class="fas fa-ticket-alt"></i> 邀请码管理</summary>
            <div class="collapsible-content">
                <div id="invitation-controls" style="margin-bottom: 15px; overflow: auto;">
                    <button id="btn-open-create-invitation-modal" class="form-button" style="float: left;">
                        <i class="fas fa-plus-circle"></i> 生成邀请码
                    </button>
                    <button id="btn-delete-invalid-codes" class="action-btn delete-btn" style="float: right;">
                        <i class="fas fa-trash-alt"></i> 删除所有失效邀请码
                    </button>
                </div>

                <div id="invitation-code-list" style="margin-top: 20px;">
                    <!-- Invitations will be loaded here by JavaScript -->
                    <p>正在加载邀请码...</p>
                </div>
            </div>
        </details>
        <!-- End New Invitation Code Management Section -->

    </div> {# End .container #}

    {# New Right Collapsible Panel for Subscription Group Management - Positioned independently #}
    <div id="subscription-panel" class="collapsed"> 
        <div class="panel-toggle-handle" title="管理订阅组">
            <i id="panel-toggle-icon" class="fas fa-chevron-left"></i>
            <span class="panel-handle-text">订阅组</span>
        </div>
        <div class="panel-actual-content">
            <h3>订阅组管理</h3>
            <hr>
            <p>此处将显示订阅组管理的相关功能。</p>
            <p>例如：</p>
            <ul>
                <li>创建新的订阅组</li>
                <li>编辑现有订阅组</li>
                <li>查看订阅组列表</li>
                <li>管理组成员</li>
            </ul>
            <p>具体功能待后续实现。</p>
        </div>
    </div>

    <!-- Modal for Creating Invitation Code -->
    <div id="create-invitation-modal" class="modal" style="display:none; position: fixed; z-index: 1002; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div class="modal-content" style="background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <span class="close-modal-btn" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 0.8;">&times;</span>
            <h2>生成邀请码</h2>
            <form id="form-create-invitation" style="margin-top: 20px;">
                <div class="form-group">
                    <label for="inv-is-random" style="display: inline-flex; align-items: center; font-weight: normal;">
                        <input type="checkbox" id="inv-is-random" name="is_random" style="width: auto; margin-right: 8px; margin-bottom: 0;">
                        随机生成邀请码 (8位)
                    </label>
                </div>
                <div class="form-group" id="inv-code-manual-group">
                    <label for="inv-code">邀请码:</label>
                    <input type="text" id="inv-code" name="code" placeholder="输入自定义邀请码" class="form-control" style="width:100%"> 
                </div>
                <div class="form-group">
                    <label for="inv-expires-in-hours">过期时间 (小时, 默认24小时, 0或不填为永不):</label>
                    <input type="number" id="inv-expires-in-hours" name="expires_in_hours" placeholder="例如: 72 (3天)" class="form-control" style="width:100%">
                </div>
                <div class="form-group">
                    <label for="inv-max-uses">生效次数 (默认1次, 0或不填为无限次):</label>
                    <input type="number" id="inv-max-uses" name="max_uses" placeholder="例如: 5" class="form-control" style="width:100%">
                </div>
                <button type="submit" class="form-button">确认生成</button>
            </form>
            <div id="modal-flash-messages" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- New Modal for Editing Subscription Config -->
    <div id="edit-subscription-config-modal" class="modal" style="display:none; position: fixed; z-index: 1003; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <span class="close-edit-sub-modal-btn" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 0.8;">&times;</span>
            <h2>编辑订阅组</h2>
            <div id="edit-subscription-form-content-area" style="margin-top: 20px;">
                <!-- Edit form will be rendered here by JavaScript -->
                <p>正在加载数据...</p>
            </div>
            <div id="edit-modal-flash-messages" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        // Ensure all JavaScript is within ONE primary DOMContentLoaded listener if possible,
        // or that each DOMContentLoaded listener is correctly and independently closed.

        // Helper for API calls (should be defined once, accessible to all parts)
        async function userManageApiCall(url, options = {}) { 
            const defaultHeaders = {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            };
            options.headers = { ...defaultHeaders, ...options.headers };
            if (options.body && typeof options.body !== 'string') {
                options.body = JSON.stringify(options.body);
            }
            try {
                const response = await fetch(url, options);
                let result = {}; 
                try {
                    if (response.status !== 204 && response.headers.get('Content-Length') !== '0') {
                        result = await response.json(); 
                    }
                } catch (jsonError) {
                    console.warn("Could not parse JSON response, status:", response.status);
                    if (!response.ok) {
                         result = { error: `Request failed with status ${response.status}` };
                    }
                }
                if (!response.ok) {
                    console.error(`API Error (${response.status}) for ${url}:`, result);
                    alert(`操作失败: ${result.error || response.statusText || '未知错误'}`);
                    return null;
                }
                 if (response.status === 204 || response.headers.get('Content-Length') === '0') {
                     return { success: true }; 
                 }
                return result;
            } catch (error) {
                console.error('Network or fetch error:', error, url, options);
                alert('网络错误或请求失败');
                return null;
            }
        }

        // User/Group Management Functions (definitions should be here if not already globally available)
        async function handleGrantPointsSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const userId = form.dataset.userId;
            const input = form.querySelector('input[type="number"]');
            const button = form.querySelector('button');
            const points = parseInt(input.value, 10);

            if (isNaN(points) || points <= 0) {
                alert('请输入有效的正整数点数。');
                return;
            }

            button.disabled = true;
            button.textContent = '发放中...';

            const result = await userManageApiCall(`/api/user/${userId}/grant_points`, {
                method: 'POST',
                body: { points: points }
            });

            if (result && result.success) {
                alert(result.message || `成功向用户 ${userId} 发放 ${points} 点数。`);
                const pointsCell = document.getElementById(`points-${userId}`);
                if (pointsCell) {
                    pointsCell.textContent = result.new_balance;
                }
                input.value = '';
            } // Error handled by apiCall

            button.disabled = false;
            button.textContent = '发放';
        }

        async function handleCreateGroupSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const input = form.querySelector('#new-group-name');
            const button = form.querySelector('button');
            const groupName = input.value.trim();

            if (!groupName) {
                alert('请输入用户组名称。');
                return;
            }

            button.disabled = true;
            button.textContent = '创建中...';

            const result = await userManageApiCall('/api/groups', {
                 method: 'POST',
                 body: { name: groupName }
             });

            if (result && result.id) {
                alert(`用户组 "${result.name}" 创建成功！`);
                location.reload(); // Simple solution: reload page
            } // Error handled by apiCall

            button.disabled = false;
            button.textContent = '创建';
            input.value = '';
        }

        async function handleAddUserToGroupSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const groupId = form.dataset.groupId;
            const input = form.querySelector('input[name="username"]');
            const button = form.querySelector('button');
            const username = input.value.trim();

            if (!username) {
                alert('请输入要添加的用户名。');
                return;
            }

            button.disabled = true;
            button.textContent = '添加中...';

            const result = await userManageApiCall(`/api/groups/${groupId}/users`, {
                method: 'POST',
                body: { username: username }
            });

            if (result && result.success !== false) { // Check for non-failure
                alert(result.message || `成功将用户 "${username}" 添加到组中。`);
                location.reload(); // Simple solution: reload page
            }

            button.disabled = false;
            button.textContent = '添加成员';
            input.value = '';
        }

        async function deleteGroup(event, groupId, groupName) {
             // 阻止事件冒泡或默认行为 (如果按钮在 form 里)
             if(event) event.preventDefault();

            if (!confirm(`确定要删除用户组 "${groupName}" 吗？组内用户不会被删除，但会从该组移除。`)) { // Unescape quotes for display
                return;
            }
            console.log(`Deleting group ${groupId}`);
            const deleteButton = event ? event.target : document.querySelector(`.group-item[data-group-id='${groupId}'] .delete-group-btn`);
            if(deleteButton) deleteButton.disabled = true;

            const result = await userManageApiCall(`/api/groups/${groupId}`, { method: 'DELETE' });

            if (result && result.success) {
                 alert(result.message || '用户组已删除。');
                 location.reload();
            } else {
                 if(deleteButton) deleteButton.disabled = false; // Re-enable on failure
            }
        }

        async function removeUserFromGroup(event, groupId, userId, username) {
             // 阻止事件冒泡或默认行为
             if(event) event.preventDefault();

             if (!confirm(`确定要将用户 "${username}" 从当前组中移除吗？`)) { // Unescape quotes for display
                 return;
             }
            console.log(`Removing user ${userId} from group ${groupId}`);
            const removeButton = event ? event.target : document.querySelector(`.group-item[data-group-id='${groupId}'] li[data-user-id='${userId}'] .remove-user-btn`);
            if (removeButton) removeButton.disabled = true;

            const result = await userManageApiCall(`/api/groups/${groupId}/users/${userId}`, { method: 'DELETE' });

            if (result && result.success) {
                 alert(result.message || '用户已从组中移除。');
                 location.reload();
            } else {
                 if (removeButton) removeButton.disabled = false; // Re-enable on failure
            }
        }

        // Main DOMContentLoaded listener that wraps ALL dynamic functionality for user_manage.html
        document.addEventListener('DOMContentLoaded', function() {

            // --- Define ALL Subscription Management Functions First ---
            const subscriptionPanel = document.getElementById('subscription-panel');
            const subPanelContent = subscriptionPanel ? subscriptionPanel.querySelector('.panel-actual-content') : null;
            const editSubscriptionModal = document.getElementById('edit-subscription-config-modal');
            const closeEditSubModalBtn = editSubscriptionModal ? editSubscriptionModal.querySelector('.close-edit-sub-modal-btn') : null;
            const editSubscriptionFormContentArea = document.getElementById('edit-subscription-form-content-area');
            const editModalFlashMessagesDiv = document.getElementById('edit-modal-flash-messages');
            let subscriptionContentLoaded = false; 

            // Log Viewer Modal Elements
            const viewLogsModal = document.getElementById('view-logs-modal');
            const closeLogsModalBtn = viewLogsModal ? viewLogsModal.querySelector('#close-logs-modal-btn') : null;
            const logsContentArea = viewLogsModal ? viewLogsModal.querySelector('#logs-content-area') : null;
            const logsModalFlashMessagesDiv = viewLogsModal ? viewLogsModal.querySelector('#logs-modal-flash-messages') : null;
            const btnShowClearLogConfirm = viewLogsModal ? viewLogsModal.querySelector('#btn-show-clear-log-confirm') : null;
            const clearLogConfirmArea = viewLogsModal ? viewLogsModal.querySelector('#clear-log-confirm-area') : null;
            const adminPasswordInput = viewLogsModal ? viewLogsModal.querySelector('#admin-password-clear-logs') : null;
            const btnConfirmClearLogs = viewLogsModal ? viewLogsModal.querySelector('#btn-confirm-clear-logs') : null;
            const btnCancelClearLogs = viewLogsModal ? viewLogsModal.querySelector('#btn-cancel-clear-logs') : null;
            // New elements for table display
            const logsTableContainer = viewLogsModal ? viewLogsModal.querySelector('#logs-table-container') : null;
            const logsTableBody = viewLogsModal ? viewLogsModal.querySelector('#logs-table tbody') : null;
            const logsLoadingMessage = viewLogsModal ? viewLogsModal.querySelector('#logs-loading-message') : null;

            function showLogsModalFlash(message, type = 'error') { 
                if (!logsModalFlashMessagesDiv) return;
                const bgColor = type === 'error' ? '#f8d7da' : (type === 'success' ? '#d1e7dd' : '#fff3cd');
                const textColor = type === 'error' ? '#842029' : (type === 'success' ? '#0f5132' : '#664d03');
                // Adjust colors for dark modal theme
                const darkBgColor = type === 'error' ? '#58151c' : (type === 'success' ? '#052c19' : '#533f00');
                const darkTextColor = type === 'error' ? '#f8d7da' : (type === 'success' ? '#d1e7dd' : '#fff3cd');
                
                logsModalFlashMessagesDiv.innerHTML = `<p style="padding: 10px; border-radius: 4px; background-color: ${darkBgColor}; color: ${darkTextColor}; border: 1px solid ${darkTextColor};">${message}</p>`;
                setTimeout(() => { logsModalFlashMessagesDiv.innerHTML = ''; }, 5000);
            }

            async function openViewLogsModal() {
                if (!viewLogsModal || !logsTableBody || !logsLoadingMessage || !logsTableContainer) return;
                // Reset view
                logsTableBody.innerHTML = ''; // Clear previous rows
                logsLoadingMessage.textContent = '正在加载日志...';
                logsLoadingMessage.style.display = 'block';
                logsTableContainer.style.display = 'block'; // Show container
                if(viewLogsModal.querySelector('#logs-table')) viewLogsModal.querySelector('#logs-table').style.display = 'none'; // Hide table initially
                
                if(logsModalFlashMessagesDiv) logsModalFlashMessagesDiv.innerHTML = '';
                if(clearLogConfirmArea) clearLogConfirmArea.style.display = 'none';
                if(btnShowClearLogConfirm) btnShowClearLogConfirm.style.display = 'inline-block';
                if(adminPasswordInput) adminPasswordInput.value = '';

                viewLogsModal.style.display = 'block';

                try {
                    const response = await fetch('/user/subscription-logs');
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || `获取日志失败: ${response.status}`);
                    }

                    logsLoadingMessage.style.display = 'none'; // Hide loading message
                    const tableElement = viewLogsModal.querySelector('#logs-table');

                    if (data && data.length > 0) {
                        if(tableElement) tableElement.style.display = 'table'; // Show table
                        data.forEach(log => {
                            const row = logsTableBody.insertRow();
                            row.insertCell().textContent = log.timestamp ? new Date(log.timestamp).toLocaleString() : 'N/A';
                            row.insertCell().textContent = log.subscription_config_name || 'N/A';
                            row.insertCell().textContent = log.target_group_name || 'N/A';
                            row.insertCell().textContent = log.username || 'N/A';
                            row.insertCell().textContent = log.points_distributed !== undefined ? log.points_distributed : 'N/A';
                            row.insertCell().textContent = log.balance_after !== undefined ? log.balance_after : 'N/A';
                        });
                    } else {
                        if(tableElement) tableElement.style.display = 'none'; // Hide table
                        logsLoadingMessage.textContent = '暂无日志记录。';
                        logsLoadingMessage.style.display = 'block'; // Show empty message
                    }
                } catch (error) {
                    logsLoadingMessage.textContent = `加载日志出错: ${error.message}`;
                    logsLoadingMessage.style.display = 'block';
                    showLogsModalFlash(`加载日志出错: ${error.message}`, 'error');
                    if(viewLogsModal.querySelector('#logs-table')) viewLogsModal.querySelector('#logs-table').style.display = 'none'; // Hide table on error
                }
            }

            // --- Define ALL Subscription Management Functions First ---
            function showEditModalFlash(message, type = 'error') { 
                if (!editModalFlashMessagesDiv) return;
                const bgColor = type === 'error' ? '#f8d7da' : (type === 'success' ? '#d1e7dd' : '#fff3cd');
                const textColor = type === 'error' ? '#842029' : (type === 'success' ? '#0f5132' : '#664d03');
                editModalFlashMessagesDiv.innerHTML = `<p style="padding: 10px; border-radius: 4px; background-color: ${bgColor}; color: ${textColor}; border: 1px solid ${textColor};">${message}</p>`;
                setTimeout(() => { editModalFlashMessagesDiv.innerHTML = ''; }, 5000);
            }

            function renderEditFormInModal(config, allGroups, modalContentArea) { 
                const freq = config.distribution_frequency;
                let dayLabel = '发放日期/星期:'; let dayPlaceholder = ''; let dayHintText = ''; let dayInputType = 'number';
                if (freq === 'weekly') { dayLabel = '发放星期 (0-6):'; dayPlaceholder = '0-6 (周一到周日)'; dayHintText = '0=周一, ..., 6=周日';}
                else if (freq === 'monthly') { dayLabel = '发放日期 (1-31):'; dayPlaceholder = '1-31'; dayHintText = '输入月份中的日期 (1-31)';}
                else { dayLabel = '发放日期 (每日无需填写):'; dayInputType = 'hidden'; }
                
                const initialSelectedGroupIds = new Set(config.target_groups.map(g => g.id));

                let formHtml = `
                    <form id="form-edit-sub-modal-${config.id}" data-config-id="${config.id}" class="subscription-actual-edit-form">
                        <div class="form-group"><label for="sub-name-modal-${config.id}">名称:</label><input type="text" id="sub-name-modal-${config.id}" name="name" value="${config.name}" required class="form-control" style="width:100%"></div>
                        <div class="form-group"><label for="sub-frequency-modal-${config.id}">发放频率:</label><select id="sub-frequency-modal-${config.id}" name="distribution_frequency" class="form-control" style="width:100%"><option value="daily" ${freq === 'daily' ? 'selected' : ''}>每日</option><option value="weekly" ${freq === 'weekly' ? 'selected' : ''}>每周</option><option value="monthly" ${freq === 'monthly' ? 'selected' : ''}>每月</option></select></div>
                        <div class="form-group sub-day-group" id="sub-day-group-modal-${config.id}" style="display: ${freq === 'daily' ? 'none' : 'block'};"><label for="sub-day-modal-${config.id}" id="sub-day-label-modal-${config.id}">${dayLabel}</label><input type="${dayInputType}" id="sub-day-modal-${config.id}" name="distribution_day" value="${config.distribution_day || ''}" placeholder="${dayPlaceholder}" class="form-control" style="width:100%"><small id="sub-day-hint-modal-${config.id}" style="display:block; margin-top:4px; font-size:0.8em; color:#666;">${dayHintText}</small></div>
                        <div class="form-group"><label for="sub-time-modal-${config.id}">发放时间 (HH:MM):</label><input type="time" id="sub-time-modal-${config.id}" name="distribution_time" value="${config.distribution_time || '00:00'}" required class="form-control" style="width:100%"></div>
                        <div class="form-group"><label for="sub-points-modal-${config.id}">发放点数:</label><input type="number" id="sub-points-modal-${config.id}" name="points_to_distribute" value="${config.points_to_distribute}" required min="0" class="form-control" style="width:100%"></div>
                        
                        <div class="form-group">
                            <label>目标用户组:</label>
                            <div class="target-groups-manager" id="target-groups-manager-${config.id}">
                                <div class="selected-groups-container" id="selected-groups-container-${config.id}">
                                    <!-- Selected groups will be rendered here by JS -->
                                </div>
                                <div class="add-group-to-sub-controls">
                                    <button type="button" class="btn-toggle-available-groups" id="btn-toggle-available-groups-${config.id}">
                                        <i class="fas fa-plus-circle"></i> 添加用户组
                                    </button>
                                    <div class="available-groups-dropdown" id="available-groups-dropdown-${config.id}">
                                        <!-- Available groups will be rendered here by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group"><label for="sub-is-active-modal-${config.id}" style="display: inline-flex; align-items: center; font-weight: normal;"><input type="checkbox" id="sub-is-active-modal-${config.id}" name="is_active" ${config.is_active ? 'checked' : ''} style="width: auto; margin-right: 8px; margin-bottom: 0;">启用此订阅</label></div>
                        <button type="submit" class="form-button">保存更改</button>
                        <button type="button" class="action-btn btn-cancel-edit-sub-modal" style="margin-left: 10px;">取消</button>
                    </form>
                `;
                modalContentArea.innerHTML = formHtml;
                const editForm = document.getElementById(`form-edit-sub-modal-${config.id}`);
                const freqSelect = editForm.querySelector(`#sub-frequency-modal-${config.id}`);
                const dayGroupDiv = editForm.querySelector(`#sub-day-group-modal-${config.id}`);
                const dayLabelEl = editForm.querySelector(`#sub-day-label-modal-${config.id}`);
                const dayInputEl = editForm.querySelector(`#sub-day-modal-${config.id}`);
                const dayHintEl = editForm.querySelector(`#sub-day-hint-modal-${config.id}`);
                
                // --- Target Group Manager JS --- 
                const groupManagerElement = document.getElementById(`target-groups-manager-${config.id}`);
                const selectedContainer = document.getElementById(`selected-groups-container-${config.id}`);
                const toggleAvailableButton = document.getElementById(`btn-toggle-available-groups-${config.id}`);
                const availableDropdown = document.getElementById(`available-groups-dropdown-${config.id}`);
                
                groupManagerElement.currentSelectedGroupIds = new Set(initialSelectedGroupIds);

                function renderSelectedGroupsUI() {
                    selectedContainer.innerHTML = ''; 
                    if (groupManagerElement.currentSelectedGroupIds.size === 0) {
                        selectedContainer.innerHTML = '<span class="no-groups-message">尚未选择用户组</span>';
                        return;
                    }
                    groupManagerElement.currentSelectedGroupIds.forEach(groupId => {
                        const group = allGroups.find(g => g.id === groupId);
                        if (group) {
                            const item = document.createElement('div');
                            item.className = 'selected-group-item';
                            item.innerHTML = `<span>${group.name}</span><button type="button" class="remove-group-from-sub-btn" data-group-id="${group.id}">&times;</button>`;
                            item.querySelector('.remove-group-from-sub-btn').addEventListener('click', function() {
                                groupManagerElement.currentSelectedGroupIds.delete(group.id);
                                renderSelectedGroupsUI();
                                renderAvailableGroupsDropdown(); 
                            });
                            selectedContainer.appendChild(item);
                        }
                    });
                }

                function renderAvailableGroupsDropdown() {
                    availableDropdown.innerHTML = ''; 
                    const available = allGroups.filter(g => !groupManagerElement.currentSelectedGroupIds.has(g.id));
                    if (available.length === 0) {
                        availableDropdown.innerHTML = '<div class="no-groups-message" style="padding: 8px 12px; text-align:left;">所有组均已添加或无可用组</div>';
                        return;
                    }
                    available.forEach(group => {
                        const item = document.createElement('div');
                        item.className = 'available-group-item';
                        item.textContent = group.name;
                        item.dataset.groupId = group.id;
                        item.addEventListener('click', function() {
                            groupManagerElement.currentSelectedGroupIds.add(group.id);
                            renderSelectedGroupsUI();
                            renderAvailableGroupsDropdown();
                            availableDropdown.style.display = 'none'; 
                        });
                        availableDropdown.appendChild(item);
                    });
                }

                toggleAvailableButton.addEventListener('click', function(event) {
                    event.stopPropagation(); 
                    const isHidden = availableDropdown.style.display === 'none';
                    if (isHidden) {
                        renderAvailableGroupsDropdown(); 
                        availableDropdown.style.display = 'block';
                    } else {
                        availableDropdown.style.display = 'none';
                    }
                });

                const clickOutsideHandler = function(event) {
                    if (availableDropdown.style.display === 'block' && 
                        !availableDropdown.contains(event.target) && 
                        event.target !== toggleAvailableButton && 
                        !toggleAvailableButton.contains(event.target)) {
                       availableDropdown.style.display = 'none';
                    }
                };
                document.addEventListener('click', clickOutsideHandler );
                
                renderSelectedGroupsUI();

                // --- End Target Group Manager JS ---

                function updateDayFieldBasedOnFrequencyModal() { 
                     const currentFreq = freqSelect.value;
                     if (currentFreq === 'daily') { dayGroupDiv.style.display = 'none'; dayInputEl.type = 'hidden'; dayInputEl.value = ''; dayHintEl.textContent = ''; }
                     else { dayGroupDiv.style.display = 'block'; dayInputEl.type = 'number';
                         if (currentFreq === 'weekly') { dayLabelEl.textContent = '发放星期 (0-6):'; dayInputEl.placeholder = '0-6 (周一到周日)'; dayHintEl.textContent = '0=周一, ..., 6=周日';}
                         else { dayLabelEl.textContent = '发放日期 (1-31):'; dayInputEl.placeholder = '1-31'; dayHintEl.textContent = '输入月份中的日期 (1-31)';}}
                }
                freqSelect.addEventListener('change', updateDayFieldBasedOnFrequencyModal);
                updateDayFieldBasedOnFrequencyModal();
                editForm.querySelector('.btn-cancel-edit-sub-modal').addEventListener('click', () => {
                    if(editSubscriptionModal) editSubscriptionModal.style.display = 'none';
                    modalContentArea.innerHTML = '';
                    document.removeEventListener('click', clickOutsideHandler); // Clean up global listener
                });
                editForm.addEventListener('submit', async function(event) { 
                    event.preventDefault();
                    const formData = new FormData(this);
                    // const targetGroupIds = Array.from(formData.getAll('target_group_ids')).map(id => parseInt(id)); // OLD way from select multiple
                    
                    // New way: Get target_group_ids from the JavaScript-managed state for the custom selector
                    // Ensure this state (e.g., a Set of IDs) is accessible here. 
                    // For simplicity, let's assume it's stored on a property of the manager div or globally scoped for this modal instance.
                    const groupManagerElement = document.getElementById(`target-groups-manager-${config.id}`);
                    const selectedGroupIds = groupManagerElement && groupManagerElement.currentSelectedGroupIds ? Array.from(groupManagerElement.currentSelectedGroupIds) : [];

                    const payload = {
                        name: formData.get('name'),
                        distribution_frequency: formData.get('distribution_frequency'),
                        distribution_day: formData.get('distribution_frequency') === 'daily' ? null : (formData.get('distribution_day') ? parseInt(formData.get('distribution_day')) : null),
                        distribution_time: formData.get('distribution_time'),
                        points_to_distribute: parseInt(formData.get('points_to_distribute')),
                        is_active: formData.get('is_active') === 'on',
                        target_group_ids: selectedGroupIds // Use the new source for group IDs
                    };
                    try {
                        const response = await fetch(`/user/subscription-configs/${config.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const responseData = await response.json();
                        if (!response.ok) {
                            showEditModalFlash(`更新失败: ${responseData.error || response.statusText}`, 'error');
                            throw new Error(responseData.error || `更新失败: ${response.statusText}`);
                        }
                        showEditModalFlash('订阅配置已更新!', 'success');
                        setTimeout(() => {
                            if(editSubscriptionModal) editSubscriptionModal.style.display = 'none';
                            modalContentArea.innerHTML = '';
                            loadSubscriptionConfigs();
                        }, 1500);
                    } catch (error) {
                        console.error('Error updating subscription config:', error);
                    }
                });
            }

            async function loadAndPopulateEditFormInModal(configId, modalContentArea) { /* ... definition ... */ 
                modalContentArea.innerHTML = `<p style="padding:10px;">正在加载编辑表单 (ID: ${configId})...</p>`;
                try {
                    const [configDetailsRes, groupsRes] = await Promise.all([
                        fetch(`/user/subscription-configs/${configId}`),
                        fetch('/api/groups')
                    ]);
                    if (!configDetailsRes.ok) throw new Error('无法加载订阅配置详情。');
                    if (!groupsRes.ok) throw new Error('无法加载用户组列表。');
                    const config = await configDetailsRes.json();
                    const allGroups = await groupsRes.json();
                    renderEditFormInModal(config, allGroups, modalContentArea);
                } catch (error) {
                    modalContentArea.innerHTML = `<p style="color:red; padding:10px;">加载编辑表单失败: ${error.message}</p>`;
                }
            }

            async function handleOpenEditSubscriptionModal(event) { /* ... definition ... */ 
                event.stopPropagation();
                const configId = event.currentTarget.dataset.id;
                if (editSubscriptionModal && editSubscriptionFormContentArea) {
                    editSubscriptionFormContentArea.innerHTML = '<p style="padding:10px;">正在加载编辑数据...</p>';
                    if(editModalFlashMessagesDiv) editModalFlashMessagesDiv.innerHTML = ''; 
                    editSubscriptionModal.style.display = 'block';
                    await loadAndPopulateEditFormInModal(configId, editSubscriptionFormContentArea); 
                }
            }

            async function handleDeleteSubscription(event) { /* ... definition ... */ 
                const configId = event.currentTarget.dataset.id;
                if (!confirm(`确定要删除订阅组 ID: ${configId} 吗？`)) return;
                try {
                    const response = await fetch(`/user/subscription-configs/${configId}`, { method: 'DELETE' });
                    const data = await response.json(); 
                    if (!response.ok) throw new Error(data.error || `删除失败: ${response.status}`);
                    alert(data.message || '订阅组已删除。');
                    loadSubscriptionConfigs();
                } catch (error) {
                    alert(`删除订阅组时出错: ${error.message}`);
                }
            }

            async function handleCreateNewSubscription() { /* ... definition ... */ 
                if (!confirm('确定要创建一个新的默认订阅组吗？')) return;
                try {
                    const response = await fetch('/user/subscription-configs', { method: 'POST' });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || `创建失败: ${response.status}`);
                    alert(`订阅组 "${data.name}" 已创建！`);
                    loadSubscriptionConfigs();
                } catch (error) {
                    alert(`创建订阅组时出错: ${error.message}`);
                }
            }

            function renderSubscriptionConfigs(configs, container) { /* ... definition ... */ 
                if (!configs || configs.length === 0) {
                    container.innerHTML = '<p>当前没有订阅组配置。</p>';
                    return;
                }
                let listHtml = '<ul style="list-style: none; padding: 0;">';
                configs.forEach(config => {
                    const isActiveText = config.is_active ? '<span style="color: green;">已启用</span>' : '<span style="color: #aaa;">已禁用</span>';
                    const timeStr = config.distribution_time || "N/A";
                    let freqStr = config.distribution_frequency.charAt(0).toUpperCase() + config.distribution_frequency.slice(1);
                    if (config.distribution_frequency === 'monthly') freqStr += ` (第 ${config.distribution_day} 天)`;
                    else if (config.distribution_frequency === 'weekly') {
                        const days = ["周一", "周二", "周三", "周四", "周五", "周六", "周日"];
                        freqStr += ` (${days[config.distribution_day] || 'N/A'})`;
                    }
                    listHtml += `
                        <li style="padding: 10px; border: 1px solid #eee; margin-bottom: 8px; border-radius: 5px; background-color: #fff;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong style="font-size: 1.1em; cursor: pointer;" class="subscription-name-clickable" data-id="${config.id}">${config.name}</strong>
                                <div>
                                    <button class="action-btn btn-open-edit-sub-modal" data-id="${config.id}" style="margin-right: 5px;" title="编辑"><i class="fas fa-edit"></i> 编辑</button>
                                    <button class="action-btn delete-btn btn-delete-subscription" data-id="${config.id}" title="删除"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <div style="font-size: 0.9em; color: #555; margin-top: 5px;">状态: ${isActiveText} | 规则: ${freqStr} 于 ${timeStr} 发放 ${config.points_to_distribute} 点</div>
                            <div style="font-size: 0.8em; color: #777;">目标组: ${config.target_groups.map(g => g.name).join(', ') || '无'}</div>
                        </li>
                    `;
                });
                listHtml += '</ul>';
                container.innerHTML = listHtml;
                document.querySelectorAll('.btn-delete-subscription').forEach(button => button.addEventListener('click', handleDeleteSubscription));
                document.querySelectorAll('.btn-open-edit-sub-modal, .subscription-name-clickable').forEach(element => {
                    element.addEventListener('click', handleOpenEditSubscriptionModal);
                });
            }

            async function loadSubscriptionConfigs() { 
                if (!subPanelContent) return;
                console.log("loadSubscriptionConfigs called");
                
                let panelHtml = `
                    <div style="margin-bottom: 15px; padding: 0 20px; display: flex; justify-content: space-between; align-items: center;">
                        <button id="btn-create-new-subscription" class="form-button">
                            <i class="fas fa-plus-circle"></i> 新建订阅组
                        </button>
                        <button id="btn-view-subscription-logs" class="action-btn" style="background-color: #6c757d; color:white; border-color: #6c757d;">
                            <i class="fas fa-history"></i> 查看日志
                        </button>
                        <button id="btn-debug-next-run" class="action-btn" title="显示下次任务运行时间" style="background-color: #ffc107; color:#212529; border-color:#ffc107;">
                            <i class="fas fa-stopwatch"></i> 调试下次运行
                        </button>
                    </div>
                    <div id="subscription-config-list-container" style="padding: 0 20px;">
                        <p style="padding:10px;">正在加载订阅组配置...</p>
                    </div>
                `;
                subPanelContent.innerHTML = panelHtml;
                console.log("Subscription panel HTML structure with button set.");
                const btnCreateNewSubscription = document.getElementById('btn-create-new-subscription');
                const btnViewLogs = document.getElementById('btn-view-subscription-logs'); // Get new button
                const btnDebugNextRun = document.getElementById('btn-debug-next-run'); // Get debug button
                
                if(btnCreateNewSubscription) {
                    btnCreateNewSubscription.addEventListener('click', handleCreateNewSubscription);
                }
                if(btnViewLogs) { 
                    btnViewLogs.addEventListener('click', function() {
                        openViewLogsModal(); 
                    });
                }
                if(btnDebugNextRun) { // Add listener for debug button
                    btnDebugNextRun.addEventListener('click', async function() {
                        btnDebugNextRun.disabled = true;
                        btnDebugNextRun.textContent = '查询中...';
                        try {
                            const response = await fetch('/user/next-distribution-time');
                            const data = await response.json();
                            if (!response.ok) {
                                throw new Error(data.error || data.message || `查询失败: ${response.status}`);
                            }
                            if (data.next_run_time) {
                                const nextRunDate = new Date(data.next_run_time);
                                const now = new Date();
                                const diffSeconds = Math.round((nextRunDate - now) / 1000);

                                if (diffSeconds > 0) {
                                    const minutes = Math.floor(diffSeconds / 60);
                                    const seconds = diffSeconds % 60;
                                    alert(`下次任务将在大约 ${minutes} 分 ${seconds} 秒后运行 (${nextRunDate.toLocaleString()})`);
                                } else {
                                    alert(`下次任务时间 (${nextRunDate.toLocaleString()}) 似乎已过。请检查任务状态或等待下一分钟。`);
                                }
                            } else {
                                alert(data.message || "无法获取下次运行时间。");
                            }
                        } catch (error) {
                            alert(`查询下次运行时间时出错: ${error.message}`);
                        }
                        btnDebugNextRun.disabled = false;
                        // Restore button text with icon if needed, otherwise just text
                        btnDebugNextRun.innerHTML = '<i class="fas fa-stopwatch"></i> 调试下次运行'; 
                    });
                }

                const listContainer = document.getElementById('subscription-config-list-container');
                try {
                    const response = await fetch('/user/subscription-configs');
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `获取订阅配置失败: ${response.status}`);
                    }
                    const configs = await response.json();
                    renderSubscriptionConfigs(configs, listContainer); 
                } catch (error) {
                    listContainer.innerHTML = `<p style="color: red;">加载订阅配置出错: ${error.message}</p>`;
                    console.error('Error loading subscription configs:', error);
                }
            }

            // --- Setup Event Listeners and Initial Calls ---
            
            // User/Group Management Listeners
            document.querySelectorAll('.grant-form').forEach(form => form.addEventListener('submit', handleGrantPointsSubmit));
            const createGroupForm = document.getElementById('create-group-form');
            if (createGroupForm) createGroupForm.addEventListener('submit', handleCreateGroupSubmit);
            document.querySelectorAll('.add-user-to-group-form').forEach(form => form.addEventListener('submit', handleAddUserToGroupSubmit));

            // Invitation Code Modal Listeners (assuming they are defined and needed)
            const btnOpenCreateInvModal = document.getElementById('btn-open-create-invitation-modal');
            const createInvModal = document.getElementById('create-invitation-modal');
            const closeInvModalBtn = createInvModal ? createInvModal.querySelector('.close-modal-btn') : null;
            const formCreateInvitation = document.getElementById('form-create-invitation');
            const invitationCodeListDiv = document.getElementById('invitation-code-list');
            const modalFlashMessagesDiv = document.getElementById('modal-flash-messages'); // Ensure this div exists in create-invitation-modal
            const invIsRandomCheckbox = document.getElementById('inv-is-random');
            const invCodeManualGroup = document.getElementById('inv-code-manual-group');
            const invCodeInput = document.getElementById('inv-code');
            const btnDeleteInvalidCodes = document.getElementById('btn-delete-invalid-codes');

            function showModalFlash(message, type = 'error', modalFlashDiv = modalFlashMessagesDiv) {
                if (!modalFlashDiv) return;
                const bgColor = type === 'error' ? '#f8d7da' : (type === 'success' ? '#d1e7dd' : '#fff3cd');
                const textColor = type === 'error' ? '#842029' : (type === 'success' ? '#0f5132' : '#664d03');
                modalFlashDiv.innerHTML = `<p style="padding: 10px; border-radius: 4px; background-color: ${bgColor}; color: ${textColor}; border: 1px solid ${textColor};">${message}</p>`;
                setTimeout(() => { modalFlashDiv.innerHTML = ''; }, 5000);
            }

            async function loadInvitationCodes() {
                if (!invitationCodeListDiv) return;
                invitationCodeListDiv.innerHTML = '<p>正在加载邀请码...</p>';
                // Ensure userManageApiCall is defined and accessible in this scope
                const responseData = await userManageApiCall('/user/invitations'); 

                if (responseData && responseData.invitations && Array.isArray(responseData.invitations)) {
                    const codesArray = responseData.invitations;
                    if (codesArray.length === 0) {
                        invitationCodeListDiv.innerHTML = '<p>暂无邀请码。</p>';
                        return;
                    }
                    let tableHtml = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>邀请码</th>
                                    <th>状态</th>
                                    <th>最大使用次数</th>
                                    <th>已使用次数</th>
                                    <th>过期时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    codesArray.forEach(code => {
                        const expiresAt = code.expires_at ? new Date(code.expires_at).toLocaleString() : '永不';
                        // const createdAt = new Date(code.created_at).toLocaleString(); // Removed as created_at is not in API response
                        const isValid = code.is_valid; 
                        const statusText = isValid ? '<span style="color: green;">有效</span>' : '<span style="color: red;">失效</span>';
                        const maxUsesText = code.max_uses === 0 ? '无限' : code.max_uses;

                        tableHtml += `
                            <tr>
                                <td><strong>${code.code}</strong></td>
                                <td>${statusText}</td>
                                <td>${maxUsesText}</td>
                                <td>${code.times_used}</td>
                                <td>${expiresAt}</td>
                                <td>
                                    <button class="action-btn delete-btn btn-delete-inv-code" data-code-id="${code.id}" title="删除此邀请码">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                </td>
                            </tr>`;
                    });
                    tableHtml += '</tbody></table>';
                    invitationCodeListDiv.innerHTML = tableHtml;

                    document.querySelectorAll('.btn-delete-inv-code').forEach(button => {
                        button.addEventListener('click', handleDeleteInvitationCode);
                    });
                } else {
                    invitationCodeListDiv.innerHTML = '<p style="color:red;">加载邀请码失败。请检查API是否正常或稍后再试。</p>';
                }
            }

            async function handleDeleteInvitationCode(event) {
                const button = event.currentTarget;
                const codeId = button.dataset.codeId;
                if (!confirm(`确定要删除此邀请码 (ID: ${codeId}) 吗？`)) return;

                button.disabled = true;
                const result = await userManageApiCall(`/user/invitations/${codeId}`, { method: 'DELETE' }); 
                if (result && (result.success || result.message || response.status === 204)) {
                    alert(result.message || '邀请码已删除。');
                    loadInvitationCodes(); 
                }
                button.disabled = false; 
            }

            if (btnOpenCreateInvModal) {
                btnOpenCreateInvModal.addEventListener('click', () => {
                    if (createInvModal) {
                        if (formCreateInvitation) formCreateInvitation.reset();
                        if(invCodeManualGroup) invCodeManualGroup.style.display = 'block';
                        if(invCodeInput) invCodeInput.disabled = false;
                        if(invIsRandomCheckbox) invIsRandomCheckbox.checked = false;
                        if(modalFlashMessagesDiv) modalFlashMessagesDiv.innerHTML = '';
                        createInvModal.style.display = 'block';
                    }
                });
            }

            if (closeInvModalBtn) {
                closeInvModalBtn.addEventListener('click', () => {
                    if (createInvModal) createInvModal.style.display = 'none';
                });
            }
            
            // Note: The global window click listener for closing modals is already present later in your script.
            // Ensure it correctly handles createInvModal.

            if (invIsRandomCheckbox && invCodeManualGroup && invCodeInput) {
                invIsRandomCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        invCodeManualGroup.style.display = 'none';
                        invCodeInput.value = ''; 
                        invCodeInput.disabled = true;
                    } else {
                        invCodeManualGroup.style.display = 'block';
                        invCodeInput.disabled = false;
                    }
                });
            }

            if (formCreateInvitation) {
                formCreateInvitation.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    const submitButton = formCreateInvitation.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.textContent = '生成中...';

                    const formData = new FormData(formCreateInvitation);
                    const payload = {
                        is_random: formData.get('is_random') === 'on',
                        code: formData.get('is_random') === 'on' ? null : formData.get('code'),
                        expires_in_hours: formData.get('expires_in_hours') ? parseInt(formData.get('expires_in_hours')) : null,
                        max_uses: formData.get('max_uses') ? parseInt(formData.get('max_uses')) : null
                    };
                    
                    if (!payload.is_random && (!payload.code || payload.code.trim() === '')) {
                        showModalFlash('自定义邀请码不能为空。');
                        submitButton.disabled = false;
                        submitButton.textContent = '确认生成';
                        return;
                    }

                    const result = await userManageApiCall('/user/invitations', { 
                        method: 'POST',
                        body: payload
                    });

                    if (result && result.id) { 
                        showModalFlash(`邀请码 "${result.code}" 创建成功!`, 'success'); // This message might be visible very briefly
                        
                        if (createInvModal) {
                            createInvModal.style.display = 'none'; // Close modal immediately
                        }
                        loadInvitationCodes(); // Refresh list
                        
                        // Re-enable and reset button text immediately after actions
                        submitButton.disabled = false;
                        submitButton.textContent = '确认生成';
                    } else if (result && result.error) {
                         showModalFlash(result.error); 
                         // Re-enable and reset button text on error
                         submitButton.disabled = false;
                         submitButton.textContent = '确认生成';
                    } else {
                        // Fallback for unexpected responses or if result is null/undefined from apiCall
                        showModalFlash(result ? (result.message || '操作完成但响应未知。') : '创建失败，请重试。');
                        submitButton.disabled = false;
                        submitButton.textContent = '确认生成';
                    }
                });
            }
            
            if (btnDeleteInvalidCodes) {
                btnDeleteInvalidCodes.addEventListener('click', async function() {
                    if (!confirm('确定要删除所有已失效的邀请码吗？此操作不可撤销。')) return;
                    
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 删除中...';

                    const result = await userManageApiCall('/user/invitations/cleanup', { method: 'DELETE' }); 

                    if (result && (result.success !== false)) { // Check for non-failure
                        alert(result.message || `成功删除了 ${result.deleted_count === undefined ? '部分或所有' : result.deleted_count} 个失效邀请码。`);
                        loadInvitationCodes();
                    }
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-trash-alt"></i> 删除所有失效邀请码';
                });
            }

            // Initial load of invitation codes
            if (document.getElementById('invitation-code-section')) {
                 loadInvitationCodes();
            }

            // Subscription Panel Toggle Logic (Simplified)
            const panelToggleHandle = subscriptionPanel ? subscriptionPanel.querySelector('.panel-toggle-handle') : null;
            if (subscriptionPanel && panelToggleHandle && subPanelContent) {
                panelToggleHandle.addEventListener('click', function() {
                    const willBeExpanded = !subscriptionPanel.classList.contains('expanded');
                    subscriptionPanel.classList.toggle('expanded');
                    if (willBeExpanded && !subscriptionContentLoaded) {
                        loadSubscriptionConfigs();
                        subscriptionContentLoaded = true;
                    }
                });

                // Initial load check if panel is set to be expanded by default (e.g. via a class)
                if (subscriptionPanel.classList.contains('expanded') && !subscriptionContentLoaded) {
                    loadSubscriptionConfigs();
                    subscriptionContentLoaded = true;
                }
            }

            // Subscription Edit Modal Close Listeners
            if (closeEditSubModalBtn) {
                closeEditSubModalBtn.addEventListener('click', () => {
                    if(editSubscriptionModal) editSubscriptionModal.style.display = 'none';
                    if(editSubscriptionFormContentArea) editSubscriptionFormContentArea.innerHTML = '';
                    if(editModalFlashMessagesDiv) editModalFlashMessagesDiv.innerHTML = '';
                });
            }
            // Log Viewer Modal Close Listeners & Clear Logic
            if (closeLogsModalBtn) {
                closeLogsModalBtn.addEventListener('click', () => {
                    if (viewLogsModal) viewLogsModal.style.display = 'none';
                });
            }
            if (btnShowClearLogConfirm) {
                btnShowClearLogConfirm.addEventListener('click', () => {
                    if(clearLogConfirmArea) clearLogConfirmArea.style.display = 'block';
                    btnShowClearLogConfirm.style.display = 'none';
                });
            }
            if (btnCancelClearLogs) {
                btnCancelClearLogs.addEventListener('click', () => {
                    if(clearLogConfirmArea) clearLogConfirmArea.style.display = 'none';
                    if(btnShowClearLogConfirm) btnShowClearLogConfirm.style.display = 'inline-block';
                    if(adminPasswordInput) adminPasswordInput.value = '';
                    if(logsModalFlashMessagesDiv) logsModalFlashMessagesDiv.innerHTML = ''; // Clear flash on cancel
                });
            }
            if (btnConfirmClearLogs) {
                btnConfirmClearLogs.addEventListener('click', async () => {
                    if (!adminPasswordInput || !adminPasswordInput.value) {
                        showLogsModalFlash('请输入管理员密码！', 'error');
                        return;
                    }
                    const password = adminPasswordInput.value;
                    try {
                        const response = await fetch('/user/clear-subscription-logs', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({ admin_password: password })
                        });
                        const result = await response.json();
                        if (!response.ok) {
                            throw new Error(result.error || `清除日志失败: ${response.status}`);
                        }
                        showLogsModalFlash(result.message || '日志已成功清除！', 'success');
                        await openViewLogsModal(); // Refresh log view (should be empty)
                        // No need to explicitly hide clearLogConfirmArea, openViewLogsModal will reset it.
                    } catch (error) {
                        showLogsModalFlash(error.message, 'error');
                    }
                    if(adminPasswordInput) adminPasswordInput.value = ''; // Clear password after attempt
                });
            }

            window.addEventListener('click', (event) => {
                if (event.target == editSubscriptionModal) {
                    editSubscriptionModal.style.display = 'none';
                    if(editSubscriptionFormContentArea) editSubscriptionFormContentArea.innerHTML = '';
                    if(editModalFlashMessagesDiv) editModalFlashMessagesDiv.innerHTML = '';
                }
                if (event.target == viewLogsModal) { // Close log modal on backdrop click
                    if (viewLogsModal) viewLogsModal.style.display = 'none';
                }
                // Also handle invitation modal backdrop click if needed
                const createInvModalCheck = document.getElementById('create-invitation-modal');
                if (event.target == createInvModalCheck) {
                    createInvModalCheck.style.display = 'none';
                }
            });

            // Function to load and initialize the timezone selector
            async function loadTimezoneSelector() {
                const selector = document.getElementById('timezone-selector');
                if (!selector) return;

                selector.disabled = true;
                selector.innerHTML = '<option value="">加载时区...</option>';

                try {
                    // Fetch available timezones and current setting concurrently
                    const [tzResponse, currentTzResponse] = await Promise.all([
                        fetch('/user/app-settings/timezones'),
                        fetch('/user/app-settings/distribution-timezone')
                    ]);

                    if (!tzResponse.ok) throw new Error('无法加载可用时区列表');
                    if (!currentTzResponse.ok) throw new Error('无法加载当前时区设置');

                    const timezones = await tzResponse.json();
                    const currentSetting = await currentTzResponse.json();
                    const currentTimezone = currentSetting.timezone;

                    selector.innerHTML = ''; // Clear loading message
                    timezones.forEach(tz => {
                        const option = document.createElement('option');
                        option.value = tz;
                        option.textContent = tz;
                        if (tz === currentTimezone) {
                            option.selected = true;
                        }
                        selector.appendChild(option);
                    });
                    selector.disabled = false;

                } catch (error) {
                    console.error("Error loading timezone selector:", error);
                    selector.innerHTML = '<option value="">加载失败</option>';
                    alert("加载时区选择器失败: " + error.message);
                }
            }

            // Function to handle timezone selection change
            async function handleTimezoneChange(event) {
                const selector = event.target;
                const newTimezone = selector.value;
                selector.disabled = true; // Disable during save

                try {
                    const response = await fetch('/user/app-settings/distribution-timezone', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ timezone: newTimezone })
                    });
                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.error || '保存时区设置失败');
                    }
                    alert(result.message || '时区设置已更新！'); // Simple feedback
                    // Optionally, trigger a page reload or update other elements if needed

                } catch (error) {
                    console.error("Error saving timezone:", error);
                    alert("保存时区设置失败: " + error.message);
                    // Revert selector to previous value? Might be complex, simple alert for now.
                    await loadTimezoneSelector(); // Reload selector to show current state from server
                } finally {
                    selector.disabled = false;
                }
            }

            // Initialize Timezone Selector on page load
            loadTimezoneSelector();
            const timezoneSelectorElement = document.getElementById('timezone-selector');
            if (timezoneSelectorElement) {
                timezoneSelectorElement.addEventListener('change', handleTimezoneChange);
            }

        }); // End of the SINGLE main DOMContentLoaded listener

    </script>

    <!-- Log Viewer Modal -->
    <div id="view-logs-modal" class="modal" style="display:none; position: fixed; z-index: 1004; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);"> {/* Slightly darker backdrop */}
        <div class="modal-content" style="margin: 5% auto; padding: 25px; border: 1px solid #1c1e22; width: 90%; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            <span class="close-modal-btn" id="close-logs-modal-btn" style="float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 0.8;">&times;</span>
            <h2>订阅点数发放日志</h2>
            <!-- <pre id="logs-content-area">正在加载日志...</pre> -->
            <div id="logs-table-container" style="max-height: 60vh; overflow-y: auto;">
                <table id="logs-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>时间戳</th>
                            <th>配置名称</th>
                            <th>用户组</th>
                            <th>用户名</th>
                            <th>发放点数</th>
                            <th>发放后余额</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Log rows will be inserted here by JS -->
                    </tbody>
                </table>
                <p id="logs-loading-message" style="text-align: center; padding: 20px;">正在加载日志...</p>
            </div>
            <div id="logs-modal-flash-messages" style="margin-top: 15px;"></div>

            <div id="clear-logs-section">
                <hr style="border-color: #3e4451; margin: 20px 0;">
                <button type="button" id="btn-show-clear-log-confirm" class="action-btn delete-btn">清除日志记录</button>
                <div id="clear-log-confirm-area" style="display:none; margin-top:10px; padding:15px; background-color: #31363f; border-radius:4px; border: 1px solid #3e4451;">
                    <label for="admin-password-clear-logs">请输入管理员密码确认清除:</label>
                    <input type="password" id="admin-password-clear-logs" name="admin_password">
                    <div style="margin-top:10px;">
                        <button type="button" id="btn-confirm-clear-logs" class="action-btn delete-btn">确认清除</button>
                        <button type="button" id="btn-cancel-clear-logs" class="action-btn" style="margin-left:10px;">取消</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html> 